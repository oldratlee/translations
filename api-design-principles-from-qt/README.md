åŸæ–‡é“¾æ¥ï¼š[API Design Principles](http://qt-project.org/wiki/API-Design-Principles) - [`Qt` Wiki](http://wiki.qt.io/)  
åŸºäº[Garyçš„å½±å“åŠ›](http://blog.csdn.net/gaoyingju)ä¸Š _Gary Gao_ çš„è¯‘æ–‡ç¨¿ï¼š[`C++`çš„`API`è®¾è®¡æŒ‡å¯¼](http://blog.csdn.net/gaoyingju/article/details/8245108)  
è¯‘æ–‡å‘åœ¨[é…·å£³ - CoolShell](http://coolshell.cn/)ï¼š[`API`è®¾è®¡åŸåˆ™](http://coolshell.cn/articles/18024.html)ï¼Œ 2017-07-25

# `API`è®¾è®¡åŸåˆ™ - `Qt`å®˜ç½‘çš„è®¾è®¡å®è·µæ€»ç»“

## ğŸ è¯‘åº 

`Qt`çš„è®¾è®¡æ°´å‡†åœ¨ä¸šç•Œå¾ˆæœ‰å£ç¢‘ï¼Œä¸€è‡´ã€æ˜“äºæŒæ¡å’Œå¼ºå¤§çš„`API`æ˜¯`Qt`æœ€è‘—åçš„ä¼˜ç‚¹ä¹‹ä¸€ã€‚æ­¤æ–‡æ—¢æ˜¯`Qt`å®˜ç½‘ä¸Šçš„`API`è®¾è®¡æŒ‡å¯¼å‡†åˆ™ï¼Œä¹Ÿæ˜¯`Qt`åœ¨`API`è®¾è®¡ä¸Šçš„å®è·µæ€»ç»“ã€‚è™½ç„¶`Qt`ç”¨çš„æ˜¯`C++`ï¼Œä½†å…¶ä¸­è®¾è®¡åŸåˆ™å’Œæ€è€ƒæ˜¯å…·æœ‰æ™®é€‚æ€§çš„ï¼ˆå¦‚æœä½ å¯¹`C++`è¿˜ä¸ç²¾é€šï¼Œå¯ä»¥å¿½ç•¥ä¸`C++`å¼ºç›¸å…³æˆ–æ˜¯è¿‡äºç»†èŠ‚çš„éƒ¨åˆ†ï¼Œä»ç„¶å¯ä»¥å­¦ä¹ æˆ–æ¢³ç†å…³äº`API`è®¾è®¡æœ€æœ‰ä»·å€¼çš„å†…å®¹ï¼‰ã€‚æ•´ä¸ªç¯‡å¹…ä¸­æœ‰å¾ˆå¤šç¤ºä¾‹ï¼Œæ˜¯å…³äº`API`è®¾è®¡ä¸€ç¯‡éš¾å¾—çš„å¥½æ–‡ç« ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç¯‡`Wiki`æœ‰ä¸€äº›å†…å®¹å¹¶ä¸å®Œæ•´ï¼Œæ‰€ä»¥ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›é˜…è¯»ä¸Šçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯¹æ­¤åšäº†ä¸€äº›ç›¸å…³çš„æ³¨é‡Šã€‚

æ„Ÿè°¢[é…·å£³](http://coolshell.cn/)åšä¸» [é™ˆçš“](http://weibo.com/haoel)çš„å…¨æ–‡å®¡æ ¡ï¼Œå¹¶å¯¹éš¾ç‚¹å’Œè¦æ³¨æ„çš„åœ°æ–¹ç»™å‡ºè´´å¿ƒçš„è¯´æ˜å’Œè¯‘æ³¨ã€‚

# `API`è®¾è®¡åŸåˆ™

ä¸€è‡´ã€æ˜“äºæŒæ¡å’Œå¼ºå¤§çš„`API`æ˜¯`Qt`æœ€è‘—åçš„ä¼˜ç‚¹ä¹‹ä¸€ã€‚æ­¤æ–‡æ€»ç»“äº†æˆ‘ä»¬åœ¨è®¾è®¡`Qt`é£æ ¼`API`çš„è¿‡ç¨‹ä¸­æ‰€ç§¯ç´¯çš„è¯€çªï¼ˆ`know-how`ï¼‰ã€‚å…¶ä¸­è®¸å¤šæ˜¯é€šç”¨å‡†åˆ™ï¼›è€Œå…¶ä»–çš„åˆ™æ›´åå‘äºçº¦å®šï¼Œéµå¾ªè¿™äº›çº¦å®šä¸»è¦æ˜¯ä¸ºäº†ä¸å·²æœ‰çš„`API`ä¿æŒä¸€è‡´ã€‚

è™½ç„¶è¿™äº›å‡†åˆ™ä¸»è¦ç”¨äºå¯¹å¤–çš„`API`ï¼ˆ`public API`ï¼‰ï¼Œä½†åœ¨è®¾è®¡å¯¹å†…çš„`API`ï¼ˆ`private API`ï¼‰æ—¶ä¹Ÿæ¨èéµå¾ªç›¸åŒçš„æŠ€å·§ï¼ˆ`techniques`ï¼‰ï¼Œä½œä¸ºå¼€å‘è€…ä¹‹é—´åä½œçš„ç¤¼ä»ªï¼ˆ`courtesy`ï¼‰ã€‚

å¦‚æœ‰å…´è¶£ä¹Ÿå¯ä»¥è¯»ä¸€ä¸‹ _Jasmin Blanchette_ çš„[Little Manual of API Design (PDF)](http://www4.in.tum.de/~blanchet/api-design.pdf) æˆ–æ˜¯æœ¬æ–‡çš„å‰èº« _Matthias Ettrich_ çš„[Designing Qt-Style C++ APIs](https://doc.qt.io/archives/qq/qq13-apis.html)ã€‚

-------------------------------------------------------------------------------

<img src="api-design.jpg" width="40%" align="right" />

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [1. å¥½`API`çš„6ä¸ªç‰¹è´¨](#1-%E5%A5%BDapi%E7%9A%846%E4%B8%AA%E7%89%B9%E8%B4%A8)
    - [1.1 æç®€](#11-%E6%9E%81%E7%AE%80)
    - [1.2 å®Œå¤‡](#12-%E5%AE%8C%E5%A4%87)
    - [1.3 è¯­ä¹‰æ¸…æ™°ç®€å•](#13-%E8%AF%AD%E4%B9%89%E6%B8%85%E6%99%B0%E7%AE%80%E5%8D%95)
    - [1.4 ç¬¦åˆç›´è§‰](#14-%E7%AC%A6%E5%90%88%E7%9B%B4%E8%A7%89)
    - [1.5 æ˜“äºè®°å¿†](#15-%E6%98%93%E4%BA%8E%E8%AE%B0%E5%BF%86)
    - [1.6 å¼•å¯¼`API`ä½¿ç”¨è€…å†™å‡ºå¯è¯»ä»£ç ](#16-%E5%BC%95%E5%AF%BCapi%E4%BD%BF%E7%94%A8%E8%80%85%E5%86%99%E5%87%BA%E5%8F%AF%E8%AF%BB%E4%BB%A3%E7%A0%81)
- [2. é™æ€å¤šæ€](#2-%E9%9D%99%E6%80%81%E5%A4%9A%E6%80%81)
    - [2.1 å¥½çš„æ¡ˆä¾‹](#21-%E5%A5%BD%E7%9A%84%E6%A1%88%E4%BE%8B)
    - [2.2 å·®çš„æ¡ˆä¾‹](#22-%E5%B7%AE%E7%9A%84%E6%A1%88%E4%BE%8B)
    - [2.3 å€¼å¾—æ–Ÿé…Œçš„æ¡ˆä¾‹](#23-%E5%80%BC%E5%BE%97%E6%96%9F%E9%85%8C%E7%9A%84%E6%A1%88%E4%BE%8B)
- [3. åŸºäºå±æ€§çš„`API`](#3-%E5%9F%BA%E4%BA%8E%E5%B1%9E%E6%80%A7%E7%9A%84api)
- [4. `C++`ç›¸å…³](#4-c%E7%9B%B8%E5%85%B3)
    - [4.1 å€¼ vs. å¯¹è±¡](#41-%E5%80%BC-vs-%E5%AF%B9%E8%B1%A1)
        - [4.1.1 æŒ‡é’ˆ vs. å¼•ç”¨](#411-%E6%8C%87%E9%92%88-vs-%E5%BC%95%E7%94%A8)
        - [4.1.2 æŒ‰å¸¸é‡å¼•ç”¨ä¼ å‚ vs. æŒ‰å€¼ä¼ å‚](#412-%E6%8C%89%E5%B8%B8%E9%87%8F%E5%BC%95%E7%94%A8%E4%BC%A0%E5%8F%82-vs-%E6%8C%89%E5%80%BC%E4%BC%A0%E5%8F%82)
    - [4.2 è™šå‡½æ•°](#42-%E8%99%9A%E5%87%BD%E6%95%B0)
        - [4.2.1 é¿å…è™šå‡½æ•°](#421-%E9%81%BF%E5%85%8D%E8%99%9A%E5%87%BD%E6%95%B0)
        - [4.2.2 è™šå‡½æ•° vs. æ‹·è´](#422-%E8%99%9A%E5%87%BD%E6%95%B0-vs-%E6%8B%B7%E8%B4%9D)
    - [4.3 å…³äº`const`](#43-%E5%85%B3%E4%BA%8Econst)
        - [4.3.1 è¾“å…¥å‚æ•°ï¼š`const`æŒ‡é’ˆ](#431-%E8%BE%93%E5%85%A5%E5%8F%82%E6%95%B0const%E6%8C%87%E9%92%88)
        - [4.3.2 è¿”å›å€¼ï¼š`const`å€¼](#432-%E8%BF%94%E5%9B%9E%E5%80%BCconst%E5%80%BC)
        - [4.3.3 è¿”å›å€¼ï¼šé`const`çš„æŒ‡é’ˆè¿˜æ˜¯æœ‰`const`çš„æŒ‡é’ˆ](#433-%E8%BF%94%E5%9B%9E%E5%80%BC%E9%9D%9Econst%E7%9A%84%E6%8C%87%E9%92%88%E8%BF%98%E6%98%AF%E6%9C%89const%E7%9A%84%E6%8C%87%E9%92%88)
        - [4.3.4 è¿”å›å€¼ï¼šæŒ‰å€¼è¿”å› è¿˜æ˜¯ æŒ‰`const`å¼•ç”¨è¿”å›ï¼Ÿ](#434-%E8%BF%94%E5%9B%9E%E5%80%BC%E6%8C%89%E5%80%BC%E8%BF%94%E5%9B%9E-%E8%BF%98%E6%98%AF-%E6%8C%89const%E5%BC%95%E7%94%A8%E8%BF%94%E5%9B%9E)
        - [4.4.5 `const` vs. å¯¹è±¡çš„çŠ¶æ€](#445-const-vs-%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%8A%B6%E6%80%81)
- [5. `API`çš„è¯­ä¹‰å’Œæ–‡æ¡£](#5-api%E7%9A%84%E8%AF%AD%E4%B9%89%E5%92%8C%E6%96%87%E6%A1%A3)
- [6. å‘½åçš„è‰ºæœ¯](#6-%E5%91%BD%E5%90%8D%E7%9A%84%E8%89%BA%E6%9C%AF)
    - [6.1 é€šç”¨çš„å‘½åè§„åˆ™](#61-%E9%80%9A%E7%94%A8%E7%9A%84%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99)
    - [6.2 ç±»çš„å‘½å](#62-%E7%B1%BB%E7%9A%84%E5%91%BD%E5%90%8D)
    - [6.3 æšä¸¾ç±»å‹åŠå…¶å€¼çš„å‘½å](#63-%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%85%B6%E5%80%BC%E7%9A%84%E5%91%BD%E5%90%8D)
    - [6.4 å‡½æ•°å’Œå‚æ•°çš„å‘½å](#64-%E5%87%BD%E6%95%B0%E5%92%8C%E5%8F%82%E6%95%B0%E7%9A%84%E5%91%BD%E5%90%8D)
    - [6.5 å¸ƒå°”ç±»å‹çš„`getter`ä¸`setter`æ–¹æ³•çš„å‘½å](#65-%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B%E7%9A%84getter%E4%B8%8Esetter%E6%96%B9%E6%B3%95%E7%9A%84%E5%91%BD%E5%90%8D)
- [7. é¿å…å¸¸è§é™·é˜±](#7-%E9%81%BF%E5%85%8D%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1)
    - [7.1 ç®€åŒ–çš„é™·é˜±](#71-%E7%AE%80%E5%8C%96%E7%9A%84%E9%99%B7%E9%98%B1)
    - [7.2 å¸ƒå°”å‚æ•°çš„é™·é˜±](#72-%E5%B8%83%E5%B0%94%E5%8F%82%E6%95%B0%E7%9A%84%E9%99%B7%E9%98%B1)
- [8. æ¡ˆä¾‹ç ”ç©¶](#8-%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6)
    - [8.1 `QProgressBar`](#81-qprogressbar)
    - [8.2 `QAbstractPrintDialog` & `QAbstractPageSizeDialog`](#82-qabstractprintdialog--qabstractpagesizedialog)
    - [8.3 `QAbstractItemModel`](#83-qabstractitemmodel)
    - [8.4 `QLayoutIterator` & `QGLayoutIterator`](#84-qlayoutiterator--qglayoutiterator)
    - [8.5 `QImageSink`](#85-qimagesink)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

-------------------------------------------------------------------------------

# 1. å¥½`API`çš„6ä¸ªç‰¹è´¨

`API`ä¹‹äºç¨‹åºå‘˜å°±å¦‚åŒå›¾å½¢ç•Œé¢ä¹‹äºæ™®é€šç”¨æˆ·ï¼ˆ`end-user`ï¼‰ã€‚`API`ä¸­çš„ã€`P`ã€å®é™…ä¸ŠæŒ‡çš„æ˜¯ã€ç¨‹åºå‘˜ã€ï¼ˆ`Programmer`ï¼‰ï¼Œè€Œä¸æ˜¯ã€ç¨‹åºã€ï¼ˆ`Program`ï¼‰ï¼Œå¼ºè°ƒçš„æ˜¯`API`æ˜¯ç»™ç¨‹åºå‘˜ä½¿ç”¨çš„è¿™ä¸€äº‹å®ã€‚

åœ¨ç¬¬13æœŸ[`Qt`å­£åˆŠ](http://doc.qt.io/archives/qq/)ï¼Œ_Matthias_ çš„[å…³äº`API`è®¾è®¡çš„æ–‡ç« ](https://doc.qt.io/archives/qq/qq13-apis.html)ä¸­æå‡ºäº†è§‚ç‚¹ï¼š`API`åº”è¯¥æç®€ï¼ˆ`minimal`ï¼‰ä¸”å®Œå¤‡ï¼ˆ`complete`ï¼‰ã€è¯­ä¹‰æ¸…æ™°ç®€å•ï¼ˆ`have clear and simple semantics`ï¼‰ã€ç¬¦åˆç›´è§‰ï¼ˆ`be intuitive`ï¼‰ã€æ˜“äºè®°å¿†ï¼ˆ`be easy to memorize`ï¼‰å’Œå¼•å¯¼`API`ä½¿ç”¨è€…å†™å‡ºå¯è¯»ä»£ç ï¼ˆ`lead to readable code`ï¼‰ã€‚

## 1.1 æç®€

æç®€çš„`API`æ˜¯æŒ‡æ¯ä¸ª`class`çš„`public`æˆå‘˜å°½å¯èƒ½å°‘ï¼Œ`public`çš„`class`ä¹Ÿå°½å¯èƒ½å°‘ã€‚è¿™æ ·çš„`API`æ›´æ˜“ç†è§£ã€è®°å¿†ã€è°ƒè¯•å’Œå˜æ›´ã€‚

## 1.2 å®Œå¤‡

å®Œå¤‡çš„`API`æ˜¯æŒ‡æœŸæœ›æœ‰çš„åŠŸèƒ½éƒ½åŒ…å«äº†ã€‚è¿™ç‚¹ä¼šå’Œä¿æŒ`API`æç®€æœ‰äº›å†²çªã€‚å¦‚æœä¸€ä¸ªæˆå‘˜å‡½æ•°æ”¾åœ¨é”™è¯¯çš„ç±»ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„æ½œåœ¨ç”¨æˆ·å°±ä¼šæ‰¾ä¸åˆ°ï¼Œè¿™ä¹Ÿæ˜¯è¿åå®Œå¤‡æ€§çš„ã€‚

## 1.3 è¯­ä¹‰æ¸…æ™°ç®€å•

å°±åƒå…¶ä»–çš„è®¾è®¡ä¸€æ ·ï¼Œæˆ‘ä»¬åº”è¯¥éµå®ˆæœ€å°‘æ„å¤–åŸåˆ™ï¼ˆ`the principle of least surprise`ï¼‰ã€‚å¥½çš„`API`åº”è¯¥å¯ä»¥è®©å¸¸è§çš„äº‹å®Œæˆçš„æ›´ç®€å•ï¼Œå¹¶æœ‰å¯ä»¥å®Œæˆä¸å¸¸è§çš„äº‹çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯å´ä¸ä¼šå…³æ³¨äºé‚£äº›ä¸å¸¸è§çš„äº‹ã€‚è§£å†³çš„æ˜¯å…·ä½“é—®é¢˜ï¼›å½“æ²¡æœ‰éœ€æ±‚æ—¶ä¸è¦è¿‡åº¦é€šç”¨åŒ–è§£å†³æ–¹æ¡ˆã€‚ï¼ˆä¸¾ä¸ªä¾‹å­ï¼Œåœ¨`Qt 3`ä¸­ï¼Œå¦‚æœä¸æ˜¯è€ƒè™‘åˆ°ã€è§£å†³å…·ä½“é—®é¢˜ã€è¿™ç‚¹ï¼Œ`QMimeSourceFactory`å°±ä¼šå‘½åæˆ`QImageLoader`å¹¶æœ‰ä¸ä¸€æ ·çš„`API`ã€‚ï¼‰

## 1.4 ç¬¦åˆç›´è§‰

å°±åƒè®¡ç®—æœºé‡Œçš„å…¶ä»–äº‹ç‰©ä¸€æ ·ï¼Œ`API`åº”è¯¥ç¬¦åˆç›´è§‰ã€‚å¯¹äºä»€ä¹ˆæ˜¯ç¬¦åˆç›´è§‰çš„ä»€ä¹ˆä¸ç¬¦åˆï¼Œä¸åŒç»éªŒå’ŒèƒŒæ™¯çš„äººä¼šæœ‰ä¸åŒçš„çœ‹æ³•ã€‚`API`ç¬¦åˆç›´è§‰çš„æµ‹è¯•æ–¹æ³•ï¼šç»éªŒä¸å¾ˆä¸°å¯Œçš„ç”¨æˆ·ä¸ç”¨é˜…è¯»`API`æ–‡æ¡£å°±èƒ½ææ‡‚`API`ï¼Œè€Œä¸”ç¨‹åºå‘˜ä¸ç”¨äº†è§£`API`å°±èƒ½çœ‹æ˜ç™½ä½¿ç”¨`API`çš„ä»£ç ã€‚

## 1.5 æ˜“äºè®°å¿†

ä¸ºä½¿`API`æ˜“äºè®°å¿†ï¼Œ`API`çš„å‘½åçº¦å®šåº”è¯¥å…·æœ‰ä¸€è‡´æ€§å’Œç²¾ç¡®æ€§ã€‚ä½¿ç”¨æ˜“äºè¯†åˆ«çš„æ¨¡å¼å’Œæ¦‚å¿µï¼Œå¹¶ä¸”é¿å…ç”¨ç¼©å†™ã€‚

## 1.6 å¼•å¯¼`API`ä½¿ç”¨è€…å†™å‡ºå¯è¯»ä»£ç 

ä»£ç åªå†™ä¸€æ¬¡ï¼Œå´è¦å¤šæ¬¡çš„é˜…è¯»ï¼ˆè¿˜æœ‰è°ƒè¯•å’Œä¿®æ”¹ï¼‰ã€‚å†™å‡ºå¯è¯»æ€§å¥½çš„ä»£ç æœ‰æ—¶å€™è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´ï¼Œä½†å¯¹äºäº§å“çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥è¯´æ˜¯èŠ‚çœäº†æ—¶é—´çš„ã€‚

æœ€åï¼Œè¦è®°ä½çš„æ˜¯ï¼Œä¸åŒçš„ç”¨æˆ·ä¼šä½¿ç”¨`API`çš„ä¸åŒéƒ¨åˆ†ã€‚å°½ç®¡ç®€å•ä½¿ç”¨å•ä¸ª`Qt`ç±»çš„å®ä¾‹åº”è¯¥ç¬¦åˆç›´è§‰ï¼Œä½†å¦‚æœæ˜¯è¦ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œè®©ç”¨æˆ·äº‹å…ˆçœ‹å¥½æ–‡æ¡£æ˜¯ä¸ªåˆç†çš„è¦æ±‚ã€‚

# 2. é™æ€å¤šæ€

ç›¸ä¼¼çš„ç±»åº”è¯¥æœ‰ç›¸ä¼¼çš„`API`ã€‚åœ¨ç»§æ‰¿ï¼ˆ`inheritance`ï¼‰åˆé€‚æ—¶å¯ä»¥ç”¨ç»§æ‰¿è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œå³è¿è¡Œæ—¶å¤šæ€ã€‚ç„¶è€Œå¤šæ€ä¹Ÿå‘ç”Ÿåœ¨è®¾è®¡é˜¶æ®µã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ç”¨`QProgressBar`æ›¿æ¢`QSlider`ï¼Œæˆ–æ˜¯ç”¨`QString`æ›¿æ¢`QByteArray`ï¼Œä½ ä¼šå‘ç°`API`çš„ç›¸ä¼¼æ€§ä½¿çš„æ›¿æ¢å¾ˆå®¹æ˜“ã€‚è¿™å³æ˜¯æ‰€è°“çš„ã€é™æ€å¤šæ€ã€ï¼ˆ`static polymorphism`ï¼‰ã€‚

é™æ€å¤šæ€ä¹Ÿä½¿è®°å¿†`API`å’Œç¼–ç¨‹æ¨¡å¼æ›´åŠ å®¹æ˜“ã€‚å› æ­¤ï¼Œä¸€ç»„ç›¸å…³çš„ç±»æœ‰ç›¸ä¼¼çš„`API`æœ‰æ—¶å€™æ¯”æ¯ä¸ªç±»éƒ½æœ‰å„è‡ªçš„ä¸€å¥—`API`æ›´å¥½ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨`Qt`ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç†ç”±è¦ä½¿ç”¨ç»§æ‰¿ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºç”¨é™æ€å¤šæ€ã€‚è¿™æ ·å¯ä»¥å‡å°‘`Qt` `public`ç±»çš„ä¸ªæ•°ï¼Œä¹Ÿä½¿åˆšå­¦ä¹ `Qt`çš„ç”¨æˆ·åœ¨ç¿»çœ‹æ–‡æ¡£æ—¶æ›´æœ‰æ–¹å‘æ„Ÿã€‚

## 2.1 å¥½çš„æ¡ˆä¾‹

`QDialogButtonBox`ä¸`QMessageBox`ï¼Œåœ¨å¤„ç†æŒ‰é’®ï¼ˆ`addButton()`ã€`setStandardButtons()`ç­‰ç­‰ï¼‰ä¸Šæœ‰ç›¸ä¼¼çš„`API`ï¼Œä¸éœ€è¦ç»§æ‰¿æŸä¸ª`QAbstractButtonBox`ç±»ã€‚

## 2.2 å·®çš„æ¡ˆä¾‹

`QTcpSocket`ä¸`QUdpSocket`éƒ½ç»§æ‰¿äº†`QAbstractSocket`ï¼Œè¿™ä¸¤ä¸ªç±»çš„äº¤äº’è¡Œä¸ºçš„æ¨¡å¼ï¼ˆ`mode of interaction`ï¼‰éå¸¸ä¸åŒã€‚ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆäººä»¥é€šç”¨å’Œæœ‰æ„ä¹‰çš„æ–¹å¼ç”¨è¿‡`QAbstractSocket`æŒ‡é’ˆï¼ˆæˆ–è€… **_èƒ½_** ä»¥é€šç”¨å’Œæœ‰æ„ä¹‰çš„æ–¹å¼ä½¿ç”¨`QAbstractSocket`æŒ‡é’ˆï¼‰ã€‚

## 2.3 å€¼å¾—æ–Ÿé…Œçš„æ¡ˆä¾‹

`QBoxLayout`æ˜¯`QHBoxLayout`ä¸`QVBoxLayout`çš„çˆ¶ç±»ã€‚å¥½å¤„ï¼šå¯ä»¥åœ¨å·¥å…·æ ä¸Šä½¿ç”¨`QBoxLayout`ï¼Œè°ƒç”¨`setOrientation()`ä½¿å…¶å˜ä¸ºæ°´å¹³/å‚ç›´ã€‚åå¤„ï¼šè¦å¤šä¸€ä¸ªç±»ï¼Œå¹¶ä¸”æœ‰å¯èƒ½å¯¼è‡´ç”¨æˆ·å†™å‡ºè¿™æ ·æ²¡ä»€ä¹ˆæ„ä¹‰çš„ä»£ç ï¼Œ`((QBoxLayout *)hbox)->setOrientation(Qt::Vertical)`ã€‚

# 3. åŸºäºå±æ€§çš„`API`

æ–°çš„`Qt`ç±»å€¾å‘äºç”¨ã€åŸºäºå±æ€§ï¼ˆ`property`ï¼‰çš„`API`ã€ï¼Œä¾‹å¦‚ï¼š

```cpp
QTimer timer;
timer.setInterval(1000);
timer.setSingleShot(true);
timer.start();
```

è¿™é‡Œçš„ **_å±æ€§_** æ˜¯æŒ‡ä»»ä½•çš„æ¦‚å¿µç‰¹å¾ï¼ˆ`conceptual attribute`ï¼‰ï¼Œæ˜¯å¯¹è±¡çŠ¶æ€çš„ä¸€éƒ¨åˆ† â€”â€” æ— è®ºå®ƒæ˜¯ä¸æ˜¯`Q_PROPERTY`ã€‚åœ¨è¯´å¾—é€šçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·åº”è¯¥å¯ä»¥ä»¥ä»»ä½•é¡ºåºè®¾ç½®å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå±æ€§ä¹‹é—´åº”è¯¥æ˜¯æ­£äº¤çš„ï¼ˆ`orthogonal`ï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥å†™æˆï¼š

```cpp
QTimer timer;
timer.setSingleShot(true);
timer.setInterval(1000);
timer.start();
```

>ã€è¯‘æ³¨ã€‘ï¼šæ­£äº¤æ€§æ˜¯æŒ‡æ”¹å˜æŸä¸ªç‰¹æ€§è€Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ç‰¹æ€§ã€‚[ã€Šç¨‹åºå‘˜ä¿®ç‚¼ä¹‹é“ã€‹](https://book.douban.com/subject/5387402/)ä¸­è®²äº†å…³äºæ­£äº¤æ€§çš„ä¸€ä¸ªç›´å‡é£æœºå æ¯çš„ä¾‹å­ï¼Œè®²å¾—æ·±å…¥æµ…å‡ºå¾ˆæœ‰ç”»é¢æ„Ÿã€‚

ä¸ºäº†æ–¹ä¾¿ï¼Œä¹Ÿå†™æˆï¼š

```cpp
timer.start(1000)ï¼›
```

ç±»ä¼¼åœ°ï¼Œå¯¹äº`QRegExp`ä¼šæ˜¯è¿™æ ·çš„ä»£ç ï¼š

```cpp
QRegExp regExp;
regExp.setCaseSensitive(Qt::CaseInsensitive);
regExp.setPattern(".");
regExp.setPatternSyntax(Qt::WildcardSyntax);
```

ä¸ºå®ç°è¿™ç§ç±»å‹çš„`API`ï¼Œéœ€è¦å€ŸåŠ©åº•å±‚å¯¹è±¡çš„å»¶è¿Ÿåˆ›å»ºã€‚ä¾‹å¦‚ï¼Œå¯¹äº`QRegExp`çš„ä¾‹å­ï¼Œåœ¨ä¸çŸ¥é“æ¨¡å¼è¯­æ³•ï¼ˆ`pattern syntax`ï¼‰çš„æƒ…å†µä¸‹ï¼Œåœ¨`setPattern()`ä¸­å»è§£é‡Š`"."`å°±ä¸ºæ—¶è¿‡æ—©äº†ã€‚

å±æ€§ä¹‹é—´å¸¸å¸¸æœ‰å…³è”çš„ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»å°å¿ƒå¤„ç†ã€‚æ€è€ƒä¸‹é¢çš„é—®é¢˜ï¼šå½“å‰é£æ ¼ï¼ˆ`style`ï¼‰æä¾›çš„ã€é»˜è®¤çš„å›¾æ ‡å°ºå¯¸ã€å±æ€§ vs. `QToolButton`çš„ã€`iconSize`ã€å±æ€§ï¼š

```cpp
toolButton->setStyle(otherStyle);
toolButton->iconSize();    // returns the default for otherStyle
toolButton->setIconSize(QSize(52, 52));
toolButton->iconSize();    // returns (52, 52)
toolButton->setStyle(yetAnotherStyle);
toolButton->iconSize();    // returns (52, 52)
```

æé†’ä¸€ä¸‹ï¼Œä¸€æ—¦è®¾ç½®äº†`iconSize`ï¼Œè®¾ç½®å°±ä¼šä¸€ç›´ä¿æŒï¼Œå³ä½¿æ”¹å˜å½“å‰é£æ ¼ã€‚è¿™ **_å¾ˆå¥½_**ã€‚ä½†æœ‰çš„æ—¶å€™éœ€è¦èƒ½é‡ç½®å±æ€§ã€‚æœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. ä¼ å…¥ä¸€ä¸ªç‰¹æ®Šå€¼ï¼ˆå¦‚`QSize()`ã€`-1`æˆ–è€…`Qt::Alignment(0)`ï¼‰æ¥è¡¨ç¤ºã€é‡ç½®ã€
1. æä¾›ä¸€ä¸ªæ˜ç¡®çš„é‡ç½®æ–¹æ³•ï¼Œå¦‚`resetFoo()`å’Œ`unsetFoo()`

å¯¹äº`iconSize`ï¼Œä½¿ç”¨`QSize()`ï¼ˆæ¯”å¦‚ `QSize(â€“1, -1)`ï¼‰æ¥è¡¨ç¤ºã€é‡ç½®ã€å°±å¤Ÿç”¨äº†ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`getter`æ–¹æ³•è¿”å›çš„ç»“æœä¸æ‰€è®¾ç½®çš„å€¼ä¸åŒã€‚ä¾‹å¦‚ï¼Œè™½ç„¶è°ƒç”¨äº†`widget->setEnabled(true)`ï¼Œä½†å¦‚æœå®ƒçš„çˆ¶`widget`å¤„äº`disabled`çŠ¶æ€ï¼Œé‚£ä¹ˆ`widget->isEnabled()`ä»ç„¶è¿”å›çš„æ˜¯`false`ã€‚è¿™æ ·æ˜¯OKçš„ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ£€æŸ¥ç»“æœï¼ˆçˆ¶`widget`å¤„äº`disabled`çŠ¶æ€ï¼Œé‡Œé¢çš„å­`widget`ä¹Ÿåº”è¯¥å˜ä¸ºç°çš„ä¸å“åº”ç”¨æˆ·æ“ä½œï¼Œå°±å¥½åƒå­`widget`è‡ªèº«å¤„äº`disabled`çŠ¶æ€ä¸€æ ·ï¼›ä¸æ­¤åŒæ—¶ï¼Œå› ä¸ºå­`widget`è®°å¾—åœ¨è‡ªå·±çš„å†…å¿ƒæ·±å¤„æ˜¯`enabled`çŠ¶æ€çš„ï¼Œåªæ˜¯ä¸€ç›´ç­‰å¾…ç€å®ƒçš„çˆ¶`widget`å˜ä¸º`enabled`ï¼‰ã€‚å½“ç„¶è¯¸å¦‚è¿™äº›éƒ½å¿…é¡»åœ¨æ–‡æ¡£ä¸­å¦¥å–„åœ°è¯´æ˜æ¸…æ¥šã€‚

# 4. `C++`ç›¸å…³

## 4.1 å€¼ vs. å¯¹è±¡

### 4.1.1 æŒ‡é’ˆ vs. å¼•ç”¨

æŒ‡é’ˆï¼ˆ`pointer`ï¼‰è¿˜æ˜¯å¼•ç”¨ï¼ˆ`reference`ï¼‰å“ªä¸ªæ˜¯æœ€å¥½çš„è¾“å‡ºå‚æ•°ï¼ˆ`out-parameters`ï¼‰ï¼Ÿ

```cpp
void getHsv(int *h, int *s, int *v) const;
void getHsv(int &h, int &s, int &v) const;
```

å¤§å¤šæ•°`C++`ä¹¦ç±æ¨èå°½å¯èƒ½ä½¿ç”¨å¼•ç”¨ï¼ŒåŸºäºä¸€ä¸ªæ™®éçš„è§‚ç‚¹ï¼šå¼•ç”¨æ¯”æŒ‡é’ˆã€æ›´åŠ å®‰å…¨å’Œä¼˜é›…ã€ã€‚ä¸æ­¤ç›¸åï¼Œæˆ‘ä»¬åœ¨å¼€å‘`Qt`æ—¶å€¾å‘äºæŒ‡é’ˆï¼Œå› ä¸ºæŒ‡é’ˆè®©ç”¨æˆ·ä»£ç å¯è¯»æ€§æ›´å¥½ã€‚æ¯”è¾ƒä¸‹é¢ä¾‹å­ï¼š

```cpp
color.getHsv(&h, &s, &v);
color.getHsv(h, s, v);
```

åªæœ‰ç¬¬ä¸€è¡Œä»£ç æ¸…æ¥šè¡¨è¾¾å‡º`h`ã€`s`ã€`v`å‚æ•°åœ¨å‡½æ•°è°ƒç”¨ä¸­éå¸¸æœ‰å¯èƒ½ä¼šè¢«ä¿®æ”¹ã€‚

è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘å™¨å¹¶ä¸å–œæ¬¢ã€å‡ºå‚ã€ï¼Œæ‰€ä½ åº”è¯¥åœ¨æ–°çš„APIä¸­é¿å…ä½¿ç”¨ã€å‡ºå‚ã€ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªç»“æ„ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```cpp
struct Hsv { int hue, saturation, value };
Hsv getHsv() const;
```

> ã€è¯‘æ³¨ã€‘ï¼šå‡½æ•°çš„ã€å…¥å‚ã€å’Œã€å‡ºå‚ã€çš„æ··ç”¨ä¼šå¯¼è‡´`API`æ¥å£è¯­ä¹‰çš„æ··ä¹±ï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œå®å‚éœ€è¦åŠ ä¸Šâ€œ&â€ï¼Œè¿™æ ·åœ¨ä»£ç é˜…è¯»çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªã€å‡ºå‚ã€ï¼Œæœ‰åˆ©äºä»£ç é˜…è¯»ã€‚ï¼ˆä½†æ˜¯è¿™æ ·åšï¼Œåœ¨å‡½æ•°å†…å°±éœ€è¦åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºçš„æƒ…å†µï¼Œå› ä¸ºå¼•ç”¨æ˜¯ä¸éœ€è¦åˆ¤æ–­çš„ï¼Œæ‰€ä»¥ï¼Œè¿™æ˜¯ä¸€ç§ trade-offï¼‰
>
> å¦å¤–ï¼Œå¦‚æœè¿™æ ·çš„å‚æ•°è¿‡å¤šçš„è¯ï¼Œæœ€å¥½ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥æŠŠæ•°æ®æ‰“åŒ…ï¼Œä¸€æ–¹é¢ï¼Œä¸ºä¸€ç»„è¿”å›å€¼å–ä¸ªåå­—ï¼Œå¦ä¸€æ–¹é¢ï¼Œè¿™æ ·æœ‰åˆ©ç”¨æ¥å£çš„ç®€å•ã€‚


### 4.1.2 æŒ‰å¸¸é‡å¼•ç”¨ä¼ å‚ vs. æŒ‰å€¼ä¼ å‚

å¦‚æœç±»å‹å¤§äº16å­—èŠ‚ï¼ŒæŒ‰å¸¸é‡å¼•ç”¨ä¼ å‚ã€‚

å¦‚æœç±»å‹æœ‰é‡å‹çš„ï¼ˆ`non-trivial`ï¼‰æ‹·è´æ„é€ å‡½æ•°ï¼ˆ`copy-constructor`ï¼‰æˆ–æ˜¯é‡å‹çš„ææ„å‡½æ•°ï¼ˆ`destructor`ï¼‰ï¼ŒæŒ‰å¸¸é‡å¼•ç”¨ä¼ å‚ä»¥é¿å…æ‰§è¡Œè¿™äº›å‡½æ•°ã€‚

å¯¹äºå…¶å®ƒçš„ç±»å‹é€šå¸¸åº”è¯¥æŒ‰å€¼ä¼ å‚ã€‚

ç¤ºä¾‹ï¼š

```cpp
void setAge(int age);
void setCategory(QChar cat);
void setName(QLatin1String name);

// const-ref is much faster than running copy-constructor and destructor
void setAlarm(const QSharedPointer<Alarm> &alarm);

// QDate, QTime, QPoint, QPointF, QSize, QSizeF, QRect
// are good examples of other classes you should pass by value.
```

>ã€è¯‘æ³¨ã€‘ï¼šè¿™æ˜¯ä¼ å¼•ç”¨å’Œä¼ å€¼çš„å·®åˆ«äº†ï¼Œå› ä¸ºä¼ å€¼ä¼šæœ‰å¯¹åƒæ‹·è´ï¼Œä¼ å¼•ç”¨åˆ™ä¸ä¼šã€‚æ‰€ä»¥ï¼Œå¦‚æœå¯¹åƒçš„æ„é€ æ¯”è¾ƒé‡çš„è¯ï¼ˆæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å¯¹åƒé‡Œçš„æˆå‘˜å˜é‡éœ€è¦çš„å†…å­˜æ¯”è¾ƒå¤§ï¼‰ï¼Œè¿™å°±ä¼šå½±å“å¾ˆå¤šæ€§èƒ½ã€‚æ‰€ä»¥ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œæœ€å¥½æ˜¯ä¼ å¼•ç”¨ã€‚ä½†æ˜¯å¦‚æœä¼ å…¥å¼•ç”¨çš„è¯ï¼Œä¼šå¯¼è‡´è¿™ä¸ªå¯¹è±¡å¯èƒ½ä¼šè¢«æ”¹å˜ï¼Œæ‰€ä»¥ä¼ å…¥`const reference`ã€‚

## 4.2 è™šå‡½æ•°

åœ¨`C++`ä¸­ï¼Œå½“ç±»çš„æˆå‘˜å‡½æ•°å£°æ˜ä¸º`virtual`ï¼Œä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡åœ¨å­ç±»é‡è½½æ­¤å‡½æ•°èƒ½å¤Ÿå®šåˆ¶å‡½æ•°çš„è¡Œä¸ºã€‚å°†å‡½æ•°å£°æ˜ä¸º`virtual`çš„ç›®çš„æ˜¯ä¸ºäº†è®©å¯¹è¿™ä¸ªå‡½æ•°å·²æœ‰çš„è°ƒç”¨å˜æˆæ‰§è¡Œå®é™…å®ä¾‹çš„ä»£ç è·¯å¾„ã€‚å¯¹äºæ²¡æœ‰åœ¨ç±»å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°å£°æ˜æˆ`virtual`ï¼Œä½ åº”è¯¥äº‹å…ˆéå¸¸æ…é‡åœ°æ€è€ƒè¿‡ã€‚

```cpp
// QTextEdit in Qt 3: member functions that have no reason for being virtual
virtual void resetFormat();
virtual void setUndoDepth( int d );
virtual void setFormat( QTextFormat *f, int flags );
virtual void ensureCursorVisible();
virtual void placeCursor( const QPoint &pos;, QTextCursor **c = 0 );
virtual void moveCursor( CursorAction action, bool select );
virtual void doKeyboardAction( KeyboardAction action );
virtual void removeSelectedText( int selNum = 0 );
virtual void removeSelection( int selNum = 0 );
virtual void setCurrentFont( const QFont &f );
virtual void setOverwriteMode( bool b ) { overWrite = b; }
```

`QTextEdit`ä»`Qt 3`ç§»æ¤åˆ°`Qt 4`çš„æ—¶å€™ï¼Œå‡ ä¹æ‰€æœ‰çš„è™šå‡½æ•°éƒ½è¢«ç§»é™¤äº†ã€‚æœ‰è¶£çš„æ˜¯ï¼ˆä½†åœ¨é¢„æ–™ä¹‹ä¸­ï¼‰ï¼Œå¹¶æ²¡æœ‰äººå¯¹æ­¤æœ‰å¤§çš„æŠ±æ€¨ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸º`Qt 3`æ²¡ç”¨åˆ°`QTextEdit`çš„å¤šæ€è¡Œä¸º â€”â€” åªæœ‰ä½ ä¼šï¼›ç®€å•åœ°è¯´ï¼Œæ²¡æœ‰ç†ç”±å»ç»§æ‰¿`QTextEdit`å¹¶é‡å†™è¿™äº›å‡½æ•°ï¼Œé™¤éä½ è‡ªå·±è°ƒç”¨äº†è¿™äº›æ–¹æ³•ã€‚å¦‚æœåœ¨`Qt`åœ¨å¤–éƒ¨ä½ çš„åº”ç”¨ç¨‹åºä½ éœ€è¦å¤šæ€ï¼Œä½ å¯ä»¥è‡ªå·±æ·»åŠ å¤šæ€ã€‚

> ã€è¯‘æ³¨ã€‘ï¼šã€å¤šæ€ã€çš„ç›®çš„åªä¸è¿‡æ˜¯ä¸ºäº†å®è·µ â€”â€” ã€ä¾èµ–äºæ¥å£è€Œä¸æ˜¯å®ç°ã€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¥å£æ˜¯ä»£ç æŠ½åƒçš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹å¼ï¼ˆåœ¨`Java/Go`ä¸­éƒ½æœ‰ä¸“é—¨çš„æ¥å£å£°æ˜è¯­æ³•ï¼‰ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ²¡æœ‰æ¥å£æŠ½åƒï¼Œä½¿ç”¨ã€å¤šæ€ã€çš„æ„ä¹‰ä¹Ÿå°±ä¸å¤§äº†ï¼Œå› ä¸ºä¹Ÿå°±æ²¡æœ‰å¿…è¦ä½¿ç”¨ã€è™šå‡½æ•°ã€äº†ã€‚

### 4.2.1 é¿å…è™šå‡½æ•°

åœ¨`Qt`ä¸­ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šç†ç”±å°½é‡å‡å°‘è™šå‡½æ•°çš„æ•°é‡ã€‚æ¯ä¸€æ¬¡å¯¹è™šå‡½æ•°çš„è°ƒç”¨ä¼šåœ¨å‡½æ•°è°ƒç”¨é“¾è·¯ä¸­æ’å…¥ä¸€ä¸ªæœªæŒæ§çš„èŠ‚ç‚¹ï¼ˆæŸç§ç¨‹åº¦ä¸Šä½¿ç»“æœæ›´æ— æ³•é¢„æµ‹ï¼‰ï¼Œä½¿å¾—`bug`ä¿®å¤å˜å¾—æ›´å¤æ‚ã€‚ç”¨æˆ·åœ¨é‡å†™çš„è™šå‡½æ•°ä¸­å¯ä»¥åšå¾ˆå¤šç–¯ç‹‚çš„äº‹ï¼š

- å‘é€äº‹ä»¶
- å‘é€ä¿¡å·
- é‡æ–°è¿›å…¥äº‹ä»¶å¾ªç¯ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ‰“å¼€ä¸€ä¸ªæ¨¡æ€æ–‡ä»¶å¯¹è¯æ¡†ï¼‰
- åˆ é™¤å¯¹è±¡ï¼ˆå³è§¦å‘ã€`delete this`ã€ï¼‰

è¿˜æœ‰å…¶ä»–å¾ˆå¤šåŸå› è¦é¿å…è¿‡åº¦ä½¿ç”¨è™šå‡½æ•°ï¼š

- æ·»åŠ ã€ç§»åŠ¨æˆ–æ˜¯åˆ é™¤è™šå‡½æ•°éƒ½å¸¦æ¥äºŒè¿›åˆ¶å…¼å®¹é—®é¢˜ï¼ˆ`binary compatibility/BC`ï¼‰
- é‡è½½è™šå‡½æ•°å¹¶ä¸å®¹æ˜“
- ç¼–è¯‘å™¨å‡ ä¹ä¸èƒ½ä¼˜åŒ–æˆ–å†…è”ï¼ˆ`inline`ï¼‰å¯¹è™šå‡½æ•°çš„è°ƒç”¨
- è™šå‡½æ•°è°ƒç”¨éœ€è¦æŸ¥æ‰¾è™šå‡½æ•°è¡¨ï¼ˆ`v-table`ï¼‰ï¼Œè¿™æ¯”æ™®é€šå‡½æ•°è°ƒç”¨æ…¢äº†2åˆ°3å€
- è™šå‡½æ•°ä½¿å¾—ç±»å¾ˆéš¾æŒ‰å€¼æ‹·è´ï¼ˆå°½ç®¡ä¹Ÿå¯ä»¥æŒ‰å€¼æ‹·è´ï¼Œä½†æ˜¯éå¸¸æ··ä¹±å¹¶ä¸”ä¸å»ºè®®è¿™æ ·åšï¼‰

ç»éªŒå‘Šè¯‰æˆ‘ä»¬ï¼Œæ²¡æœ‰è™šå‡½æ•°çš„ç±»ä¸€èˆ¬`bug`æ›´å°‘ã€ç»´æŠ¤æˆæœ¬ä¹Ÿæ›´ä½ã€‚

ä¸€èˆ¬çš„ç»éªŒæ³•åˆ™æ˜¯ï¼Œé™¤éæˆ‘ä»¬ä»¥è¿™ä¸ªç±»ä½œä¸ºå·¥å…·é›†æä¾›è€Œä¸”æœ‰å¾ˆå¤šç”¨æˆ·æ¥è°ƒç”¨æŸä¸ªç±»çš„è™šå‡½æ•°ï¼Œå¦åˆ™è¿™ä¸ªå‡½æ•°ä¹æˆä¸åº”è¯¥è®¾è®¡æˆè™šå‡½æ•°ã€‚

>ã€è¯‘æ³¨ã€‘ï¼š
>
> 1. ä½¿ç”¨è™šå‡½æ•°æ—¶ï¼Œä½ éœ€è¦å¯¹ç¼–è¯‘å™¨çš„å†…éƒ¨è¡Œä¸ºéå¸¸æ¸…æ¥šï¼Œå¦åˆ™ï¼Œä½ ä¼šåœ¨ä½¿ç”¨è™šå‡½æ•°æ—¶ï¼Œè§‰å¾—æœ‰å¥½äº›ã€å¤æ€ªã€çš„é—®é¢˜å‘ç”Ÿã€‚æ¯”å¦‚åœ¨åˆ›å»ºæ•°ç»„å¯¹è±¡çš„æ—¶å€™ã€‚
> 2. åœ¨`C++`ä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªåŸºç¡€ç±»ï¼Œè¿™ä¸ªåŸºç¡€ç±»ä¸­å·²ç»å®ç°å¥½äº†å¾ˆå¤šåŠŸèƒ½ï¼Œç„¶åæŠŠå…¶ä¸­çš„ä¸€äº›å‡½æ•°æ”¾ç»™å­ç±»å»ä¿®æ”¹å’Œå®ç°ã€‚è¿™ç§æ–¹æ³•åœ¨çˆ¶ç±»å’Œå­ç±»éƒ½æ˜¯ä¸€ç»„å¼€å‘äººå‘˜ç»´æŠ¤æ—¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœè¿™æ˜¯ä¸¤ç»„å¼€å‘äººå‘˜ï¼Œè¿™å°±ä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜äº†ï¼Œå°±åƒ`Qt`è¿™æ ·ï¼Œå­ç±»å®Œå…¨æ— æ³•æ§åˆ¶ï¼Œå…¨ä¸–ç•Œçš„å¼€å‘äººå‘˜æƒ³å¹²ä»€ä¹ˆå°±å¹²ä»€ä¹ˆã€‚æ‰€ä»¥ï¼Œå­ç±»çš„ä»£ç å’Œçˆ¶ç±»çš„ä»£ç åœ¨å…¼å®¹ä¸Šå°±ä¼šå‡ºç°å¾ˆå¤šå¾ˆå¤šé—®é¢˜ã€‚æ‰€ä»¥ï¼Œè¿˜æ˜¯ä¸Šé¢æ‰€è¯´ï¼Œå…¶å®ï¼Œè™šå‡½æ•°åº”è¯¥å£°æ˜åœ¨æ¥å£çš„è¯­ä¹‰é‡Œï¼ˆè¿™å°±æ˜¯è®¾è®¡æ¨¡å¼çš„ä¸¤ä¸ªå®—æ—¨â€”â€”ä¾èµ–äºæ¥å£ï¼Œè€Œä¸æ˜¯å®ç°ï¼›é’Ÿçˆ±äºç»„åˆï¼Œè€Œä¸æ˜¯ç»§æ‰¿ã€‚ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ`Java`å’Œ`Go`è¯­è¨€ä½¿ç”¨`interface`å…³é”®å­—çš„åŸå› ï¼Œ`C++`åœ¨å¤šæ€çš„è¯­ä¹‰ä¸Šéå¸¸å®¹æ˜“æ»¥ç”¨ï¼‰

### 4.2.2 è™šå‡½æ•° vs. æ‹·è´

å¤šæ€å¯¹è±¡ï¼ˆ`polymorphic objects`ï¼‰å’Œå€¼ç±»å‹çš„ç±»ï¼ˆ`value-type classes`ï¼‰ä¸¤è€…å¾ˆéš¾åä½œå¥½ã€‚

åŒ…å«è™šå‡½æ•°çš„ç±»å¿…é¡»æŠŠææ„å‡½æ•°å£°æ˜ä¸ºè™šå‡½æ•°ï¼Œä»¥é˜²æ­¢çˆ¶ç±»ææ„æ—¶æ²¡æœ‰æ¸…ç†å­ç±»çš„æ•°æ®ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

å¦‚æœè¦ä½¿ä¸€ä¸ªç±»èƒ½å¤Ÿæ‹·è´ã€èµ‹å€¼æˆ–æŒ‰å€¼æ¯”è¾ƒï¼Œå¾€å¾€éœ€è¦æ‹·è´æ„é€ å‡½æ•°ã€èµ‹å€¼æ“ä½œç¬¦ï¼ˆ`operator =`ï¼‰å’Œç›¸ç­‰æ“ä½œç¬¦ï¼ˆ`operator ==`ï¼‰ã€‚

```cpp
class CopyClass {
public:
    CopyClass();
    CopyClass(const CopyClass &other);
    ~CopyClass();
    CopyClass &operator =(const CopyClass &other);
    bool operator ==(const CopyClass &other) const;
    bool operator !=(const CopyClass &other) const;

    virtual void setValue(int v);
};
```

å¦‚æœç»§æ‰¿`CopyClass`è¿™ä¸ªç±»ï¼Œé¢„æ–™ä¹‹å¤–çš„äº‹å°±å·²ç»åœ¨ç¼–ç æ—¶é…é…¿äº†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰è™šæˆå‘˜å‡½æ•°å’Œè™šææ„å‡½æ•°ï¼Œå°±ä¸èƒ½åˆ›å»ºå‡ºå¯ä»¥å¤šæ€çš„å­ç±»ã€‚ç„¶è€Œï¼Œå¦‚æœå­˜åœ¨è™šæˆå‘˜å‡½æ•°å’Œè™šææ„å‡½æ•°ï¼Œè¿™çªç„¶å˜æˆäº†è¦æœ‰å­ç±»å»ç»§æ‰¿çš„ç†ç”±ï¼Œè€Œä¸”å¼€å§‹å˜å¾—å¤æ‚äº†ã€‚**_èµ·åˆè®¤ä¸ºåªè¦ç®€å•å£°æ˜ä¸Šè™šæ“ä½œç¬¦é‡è½½å‡½æ•°ï¼ˆ`virtual operators`ï¼‰ã€‚_** ä½†å…¶å®æ˜¯èµ°ä¸Šäº†ä¸€æ¡æ··ä¹±å’Œæ¯ç­ä¹‹è·¯ï¼ˆç ´åäº†ä»£ç çš„å¯è¯»æ€§ï¼‰ã€‚çœ‹çœ‹ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼š

```cpp
class OtherClass {
public:
    const CopyClass &instance() const; // è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥èµ‹å€¼ä»€ä¹ˆï¼Ÿ
};
```

ï¼ˆè¿™éƒ¨ä»½è¿˜æœªå®Œæˆï¼‰

>ã€è¯‘æ³¨ã€‘ï¼šå› ä¸ºåŸæ–‡ä¸Šè¯´ï¼Œè¿™éƒ¨ä»½å¹¶æ²¡æœ‰å®Œæˆï¼Œæ‰€ä»¥ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰ææ‡‚åŸæ–‡å…·ä½“ä¹Ÿæ˜¯æƒ³è¡¨è¾¾ä»€ä¹ˆã€‚ä¸è¿‡ï¼Œå°±æ ‡é¢˜è€Œè¨€ï¼ŒåŸæ–‡æ˜¯æƒ³è¯´ï¼Œåœ¨å¤šæ€çš„æƒ…å†µä¸‹æ‹·è´å¯¹è±¡æ‰€å¸¦æ¥çš„é—®é¢˜ï¼Ÿï¼Ÿ

## 4.3 å…³äº`const`

**_`C++`çš„å…³é”®è¯`const`è¡¨æ˜äº†å†…å®¹ä¸ä¼šæ”¹å˜æˆ–æ˜¯æ²¡æœ‰å‰¯ä½œç”¨ã€‚å¯ä»¥åº”ç”¨äºç®€å•çš„å€¼ã€æŒ‡é’ˆåŠæŒ‡é’ˆæ‰€æŒ‡çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªç‰¹åˆ«çš„å±æ€§åº”ç”¨äºç±»çš„æˆå‘˜å‡½æ•°ä¸Šï¼Œè¡¨ç¤ºæˆå‘˜å‡½æ•°ä¸èƒ½ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ã€‚_**

ç„¶è€Œï¼Œ`const`æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¤ªå¤§çš„ä»·å€¼ â€”â€” å¾ˆå¤šç¼–ç¨‹è¯­è¨€ç”šè‡³æ²¡æœ‰ç±»ä¼¼`const`çš„å…³é”®è¯ï¼Œä½†æ˜¯å´å¹¶æ²¡æœ‰å› æ­¤äº§ç”Ÿé—®é¢˜ã€‚å®é™…ä¸Šï¼Œå¦‚æœä½ ä¸ç”¨å‡½æ•°é‡è½½ï¼Œå¹¶åœ¨`C++`æºä»£ç ç”¨æœç´¢å¹¶åˆ é™¤æ‰€æœ‰çš„`const`ï¼Œå‡ ä¹æ€»èƒ½ç¼–è¯‘é€šè¿‡å¹¶ä¸”æ­£å¸¸è¿è¡Œã€‚å°½é‡è®©ä½¿ç”¨çš„`const`ä¿æŒå®ç”¨æœ‰æ•ˆï¼Œè¿™ç‚¹å¾ˆé‡è¦ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨`Qt`çš„`API`è®¾è®¡ä¸­ä¸`const`ç›¸å…³çš„åœºæ™¯ã€‚

### 4.3.1 è¾“å…¥å‚æ•°ï¼š`const`æŒ‡é’ˆ

æœ‰è¾“å…¥æŒ‡é’ˆå‚æ•°çš„`const`æˆå‘˜å‡½æ•°ï¼Œå‡ ä¹æ€»æ˜¯`const`æŒ‡é’ˆå‚æ•°ã€‚

å¦‚æœå‡½æ•°å£°æ˜ä¸º`const`ï¼Œæ„å‘³ç€æ—¢æ²¡æœ‰å‰¯ä½œç”¨ï¼Œä¹Ÿä¸ä¼šæ”¹å˜å¯¹è±¡çš„å¯è§çŠ¶æ€ã€‚é‚£ä¸ºä»€ä¹ˆå®ƒéœ€è¦ä¸€ä¸ªæ²¡æœ‰`const`é™å®šçš„è¾“å…¥å‚æ•°å‘¢ï¼Ÿè®°ä½`const`ç±»å‹çš„å‡½æ•°é€šå¸¸è¢«å…¶ä»–`const`ç±»å‹çš„å‡½æ•°è°ƒç”¨ï¼Œæ¥æ”¶åˆ°çš„ä¸€èˆ¬éƒ½æ˜¯`const`æŒ‡é’ˆï¼ˆåªè¦ä¸ä¸»åŠ¨`const_cast`ï¼Œæˆ‘ä»¬æ¨èå°½é‡é¿å…ä½¿ç”¨`const_cast`ï¼‰

ä»¥å‰ï¼š

```cpp
bool QWidget::isVisibleTo(QWidget *ancestor) const;
bool QWidget::isEnabledTo(QWidget *ancestor) const;
QPoint QWidget::mapFrom(QWidget *ancestor, const QPoint &pos) const;
```

`QWidget`å£°æ˜äº†è®¸å¤šé`const`æŒ‡é’ˆè¾“å…¥å‚æ•°çš„`const`æˆå‘˜å‡½æ•°ã€‚æ³¨æ„ï¼Œè¿™äº›å‡½æ•°å¯ä»¥ä¿®æ”¹ä¼ å…¥çš„å‚æ•°ï¼Œä¸èƒ½ä¿®æ”¹å¯¹è±¡è‡ªå·±ã€‚ä½¿ç”¨è¿™æ ·çš„å‡½æ•°å¸¸å¸¸è¦å€ŸåŠ©`const_cast`è½¬æ¢ã€‚å¦‚æœæ˜¯`const`æŒ‡é’ˆè¾“å…¥å‚æ•°ï¼Œå°±å¯ä»¥é¿å…è¿™æ ·çš„è½¬æ¢äº†ã€‚

ä¹‹åï¼š

```cpp
bool QWidget::isVisibleTo(const QWidget *ancestor) const;
bool QWidget::isEnabledTo(const QWidget *ancestor) const;
QPoint QWidget::mapFrom(const QWidget *ancestor, const QPoint &pos) const;
```

æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨`QGraphicsItem`ä¸­å¯¹æ­¤åšäº†ä¿®æ­£ï¼Œä½†æ˜¯`QWidget`è¦ç­‰åˆ°`Qt 5`:

```cpp
bool isVisibleTo(const QGraphicsItem *parent) const;
QPointF mapFromItem (const QGraphicsItem *item, const QPointF &point) const;
```

### 4.3.2 è¿”å›å€¼ï¼š`const`å€¼

è°ƒç”¨å‡½æ•°è¿”å›çš„éå¼•ç”¨ç±»å‹çš„ç»“æœï¼Œç§°ä¹‹ä¸ºå³å€¼ï¼ˆ`R-value`ï¼‰ã€‚

éç±»ï¼ˆ`non-class`ï¼‰çš„å³å€¼æ€»æ˜¯æ— `cv`é™å®šç±»å‹ï¼ˆ`cv-unqualified type`ï¼‰ã€‚è™½ç„¶ä»è¯­æ³•ä¸Šè®²ï¼ŒåŠ ä¸Š`const`ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œå› ä¸ºé‰´äºè®¿é—®æƒé™è¿™äº›å€¼æ˜¯ä¸èƒ½æ”¹å˜çš„ã€‚å¤šæ•°ç°ä»£ç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™æ ·çš„ä»£ç æ—¶ä¼šæç¤ºè­¦å‘Šä¿¡æ¯ã€‚

> ã€è¯‘æ³¨ã€‘ï¼š`cv-qualified`çš„ç±»å‹ï¼ˆä¸`cv-unqualified`ç›¸åï¼‰æ˜¯ç”±`const`æˆ–è€…`volatile`æˆ–è€…`volatile const`é™å®šçš„ç±»å‹ï¼›è¯¦è§[cv (const and volatile) type qualifiers - `C++`è¯­è¨€å‚è€ƒ](http://en.cppreference.com/w/cpp/language/cv)ã€‚

å½“åœ¨ç±»ç±»å‹ï¼ˆ`class type`ï¼‰å³å€¼ä¸Šæ·»åŠ `const`å…³é”®å­—ï¼Œåˆ™ç¦æ­¢è®¿é—®é`const`æˆå‘˜å‡½æ•°ä»¥åŠå¯¹æˆå‘˜çš„ç›´æ¥æ“ä½œã€‚

ä¸åŠ `const`åˆ™æ²¡æœ‰ä»¥ä¸Šçš„é™åˆ¶ï¼Œä½†å‡ ä¹æ²¡æœ‰å¿…è¦åŠ ä¸Š`const`ï¼Œå› ä¸ºå³å€¼å¯¹è±¡ç”Ÿå­˜æ—¶é—´ï¼ˆ`life time`ï¼‰çš„ç»“æŸä¸€èˆ¬åœ¨`C++`æ¸…ç†çš„æ—¶å€™ï¼ˆé€šä¿—çš„è¯´ï¼Œä¸‹ä¸€ä¸ªåˆ†å·åœ°æ–¹ï¼‰ï¼Œè€Œå¯¹å³å€¼å¯¹è±¡çš„ä¿®æ”¹éšç€å³å€¼å¯¹è±¡çš„ç”Ÿå­˜æ—¶é—´ä¹Ÿä¸€èµ·ç»“æŸäº†ï¼ˆä¹Ÿå°±æ˜¯æœ¬æ¡è¯­å¥çš„æ‰§è¡Œå®Œæˆçš„æ—¶å€™ï¼‰ã€‚

ç¤ºä¾‹ï¼š

```cpp
struct Foo {
    void setValue(int v) { value = v; }
    int value;
};

Foo foo() {
    return Foo();
}

const Foo cfoo() {
    return Foo();
}

int main() {
    // The following does compile, foo() is non-const R-value which
    // can't be assigned to (this generally requires an L-value)
    // but member access leads to a L-value:
    foo().value = 1; // Ok, but temporary will be thrown away at the end of the full-expression.

    // The following does compile, foo() is non-const R-value which
    // can't be assigned to, but calling (even non-const) member
    // function is fine:
    foo().setValue(1); // Ok, but temporary will be thrown away at the end of the full-expression.

    // The following does _not_compile, foo() is ''const'' R-value
    // with const member which member access can't be assigned to:
    cfoo().value = 1; // Not ok.

    // The following does _not_compile, foo() is ''const'' R-value,
    // one cannot call non-const member functions:
    cfoo().setValue(1); // Not ok
}
```

> ã€è¯‘æ³¨ã€‘ï¼šä¸Šè¿°çš„ä»£ç è¯´æ˜ï¼Œå¦‚æœè¿”å›å€¼ä¸æ˜¯`const`çš„ï¼Œä»£ç å¯ä»¥é¡ºåˆ©ç¼–è¯‘é€šè¿‡ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œå› ä¸ºé‚£ä¸ªä¸´æ—¶å¯¹åƒé©¬ä¸Šå°±è¢«æŠ›å¼ƒäº†ã€‚æ‰€ä»¥ï¼Œè¿™æ ·çš„æ— ç”¨çš„ä»£ç æœ€å¥½è¿˜æ˜¯åœ¨ç¼–è¯‘æ—¶æŠ¥ä¸ªé”™ï¼Œä»¥å…å½“æ—¶å¤´è„‘å‘çƒ­æƒ³é”™äº†ï¼Œå†™äº†ä¸€æ®µæ²¡ç”¨ä½†è¿˜ä»¥ä¸ºæœ‰ç”¨çš„ä»£ç ã€‚

### 4.3.3 è¿”å›å€¼ï¼šé`const`çš„æŒ‡é’ˆè¿˜æ˜¯æœ‰`const`çš„æŒ‡é’ˆ

è°ˆåˆ°`const`å‡½æ•°åº”è¯¥è¿”å›é`const`çš„æŒ‡é’ˆè¿˜æ˜¯`const`æŒ‡é’ˆè¿™ä¸ªè¯é¢˜æ—¶ï¼Œå¤šæ•°äººå‘ç°åœ¨`C++`ä¸­å…³äºã€`const`æ­£ç¡®æ€§ã€ï¼ˆ`const correctness`ï¼‰åœ¨æ¦‚å¿µä¸Šäº§ç”Ÿäº†åˆ†æ­§ã€‚ _é—®é¢˜èµ·æºæ˜¯ï¼š**`const`å‡½æ•°æœ¬èº«ä¸èƒ½ä¿®æ”¹å¯¹è±¡è‡ªèº«çš„çŠ¶æ€ï¼Œå´å¯ä»¥è¿”å›æˆå‘˜çš„é`const`æŒ‡é’ˆ**ã€‚è¿”å›æŒ‡é’ˆè¿™ä¸ªç®€å•åŠ¨ä½œæœ¬èº«æ—¢ä¸ä¼šå½±å“æ•´ä¸ªå¯¹è±¡çš„å¯è§çŠ¶æ€ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šæ”¹å˜è¿™ä¸ªå‡½æ•°èŒè´£èŒƒå›´å†…æ¶‰åŠçš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œè¿™å´ä½¿å¾—ç¨‹åºå‘˜å¯ä»¥é—´æ¥è®¿é—®å¹¶ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ã€‚_

ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†é€šè¿‡è¿”å›é`const`æŒ‡é’ˆçš„`const`å‡½æ•°ç»•å¼€`const`çº¦å®šï¼ˆ`constness`ï¼‰çš„è¯¸å¤šæ–¹å¼ä¸­çš„ä¸€ç§ï¼š

```cpp
QVariant CustomWidget::inputMethodQuery(Qt::InputMethodQuery query) const {
    moveBy(10, 10); // doesn't compile!
    window()->childAt(mapTo(window(), rect().center()))->moveBy(10, 10); // compiles!
}
```

è¿”å›`const`æŒ‡é’ˆçš„å‡½æ•°æ­£æ˜¯ä¿æŠ¤ä»¥é¿å…è¿™äº›ï¼ˆå¯èƒ½æ˜¯ä¸æœŸæœ›çš„/æ²¡æœ‰é¢„æ–™åˆ°çš„ï¼‰å‰¯ä½œç”¨ï¼Œè‡³å°‘æ˜¯åœ¨ä¸€å®šç¨‹åº¦ä¸Šã€‚ä½†å“ªä¸ªå‡½æ•°ä½ ä¼šè§‰å¾—æ›´æƒ³è¿”å›`const`æŒ‡é’ˆï¼Œæˆ–æ˜¯ä¸æ­¢ä¸€ä¸ªå‡½æ•°ï¼Ÿ

è‹¥é‡‡ç”¨`const`æ­£ç¡®ï¼ˆ`const-correct`ï¼‰çš„æ–¹æ³•ï¼Œæ¯ä¸ªè¿”å›æŸä¸ªæˆå‘˜çš„æŒ‡é’ˆï¼ˆæˆ–å¤šä¸ªæŒ‡å‘æˆå‘˜çš„æŒ‡é’ˆï¼‰çš„`const`å‡½æ•°å¿…é¡»è¿”å›`const`æŒ‡é’ˆã€‚åœ¨å®è·µä¸­ï¼Œå¾ˆä¸å¹¸è¿™æ ·çš„åšæ³•å°†å¯¼è‡´æ— æ³•ä½¿ç”¨çš„`API`ï¼š

```cpp
QGraphicsScene scene;
// â€¦ populate scene

foreach (const QGraphicsItem *item, scene.items()) {
    item->setPos(qrand() % 500, qrand() % 500); // doesn't compile! item is a const pointer
}
```

`QGraphicsScene::items()`æ˜¯ä¸€ä¸ª`const`å‡½æ•°ï¼Œé¡ºç€æ€è€ƒçœ‹èµ·æ¥è¿™ä¸ªå‡½æ•°åªåº”è¯¥è¿”å›`const`æŒ‡é’ˆã€‚

åœ¨`Qt`ä¸­ï¼Œæˆ‘ä»¬å‡ ä¹åªæœ‰é`const`çš„ä½¿ç”¨æ¨¡å¼ã€‚æˆ‘ä»¬é€‰æ‹©çš„æ˜¯å®ç”¨è·¯å­ï¼š
ç›¸æ¯”æ»¥ç”¨é`const`æŒ‡é’ˆè¿”å›ç±»å‹å¸¦æ¥çš„é—®é¢˜ï¼Œè¿”å›`const`æŒ‡é’ˆæ›´å¯èƒ½æ‹›è‡´è¿‡åˆ†ä½¿ç”¨`const_cast`çš„é—®é¢˜ã€‚

### 4.3.4 è¿”å›å€¼ï¼šæŒ‰å€¼è¿”å› è¿˜æ˜¯ æŒ‰`const`å¼•ç”¨è¿”å›ï¼Ÿ

è‹¥è¿”å›çš„æ˜¯å¯¹è±¡çš„æ‹·è´ï¼Œé‚£ä¹ˆè¿”å›`const`å¼•ç”¨æ˜¯æ›´ç›´æ¥çš„æ–¹æ¡ˆï¼›
ç„¶è€Œï¼Œè¿™æ ·çš„åšæ³•é™åˆ¶äº†åé¢æƒ³è¦å¯¹è¿™ä¸ªç±»çš„é‡æ„ï¼ˆ`refactor`ï¼‰ã€‚
ï¼ˆä»¥`d-point`çš„æƒ¯ç”¨æ³•ï¼ˆ`idiom`ï¼‰ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æ”¹å˜`Qt`ç±»åœ¨å†…å­˜è¡¨ç¤ºï¼ˆ`memory representation`ï¼‰ï¼›ä½†å´ä¸èƒ½åœ¨ä¸ç ´åäºŒè¿›åˆ¶å…¼å®¹æ€§çš„æƒ…å†µä¸‹æŠŠæ”¹å˜å‡½æ•°çš„ç­¾åï¼Œè¿”å›å€¼ä»`const QFoo &`å˜ä¸º`QFoo`ã€‚ï¼‰
åŸºäºè¿™ä¸ªåŸå› ï¼Œé™¤å»å¯¹è¿è¡Œé€Ÿåº¦æ•æ„Ÿï¼ˆ`speed is critical`ï¼‰è€Œé‡æ„ä¸æ˜¯é—®é¢˜çš„ä¸ªåˆ«æƒ…å½¢ï¼ˆä¾‹å¦‚ï¼Œ`QList::at()`ï¼‰ï¼Œæˆ‘ä»¬ä¸€èˆ¬è¿”å›`QFoo`è€Œä¸æ˜¯`const QFoo &`ã€‚

> ã€è¯‘æ³¨ã€‘ï¼šå‚çœ‹ã€ŠEffective C++ã€‹ä¸­æ¡æ¬¾23ï¼šDon't try to return a reference when you must return an object

### 4.4.5 `const` vs. å¯¹è±¡çš„çŠ¶æ€

`const`æ­£ç¡®æ€§ï¼ˆ`const correctness`ï¼‰çš„é—®é¢˜å°±åƒ`C`åœˆå­ä¸­`vi`ä¸`emacs`çš„è®¨è®ºï¼Œå› ä¸ºè¿™ä¸ªè¯é¢˜åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å­˜åœ¨åˆ†æ­§ï¼ˆæ¯”å¦‚åŸºäºæŒ‡é’ˆçš„å‡½æ•°ï¼‰ã€‚

ä½†é€šç”¨å‡†åˆ™æ˜¯`const`å‡½æ•°ä¸èƒ½æ”¹å˜ç±»çš„å¯è§çŠ¶æ€ã€‚ã€çŠ¶æ€ã€çš„æ„æ€æ˜¯ã€è‡ªèº«ä»¥åŠæ¶‰åŠçš„èŒè´£ã€ã€‚è¿™å¹¶ä¸æ˜¯æŒ‡é`const`å‡½æ•°èƒ½å¤Ÿæ”¹å˜è‡ªèº«çš„ç§æœ‰æˆå‘˜ï¼Œä¹Ÿä¸æ˜¯æŒ‡`const`å‡½æ•°æ”¹å˜ä¸äº†ã€‚è€Œæ˜¯æŒ‡å‡½æ•°æ˜¯æ´»è·ƒçš„å¹¶å­˜åœ¨å¯è§çš„å‰¯ä½œç”¨ï¼ˆ`visible side effects`ï¼‰ã€‚`const`å‡½æ•°ä¸€èˆ¬æ²¡æœ‰ä»»ä½•å¯è§çš„å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ï¼š

```cpp
QSize size = widget->sizeHint(); // const
widget->move(10, 10); // not const
```

ä»£ç†ï¼ˆ`delegate`ï¼‰è´Ÿè´£åœ¨å…¶å®ƒå¯¹è±¡ä¸Šç»˜åˆ¶å†…å®¹ã€‚
å®ƒçš„çŠ¶æ€åŒ…æ‹¬å®ƒçš„èŒè´£ï¼Œå› æ­¤åŒ…æ‹¬åœ¨å“ªä¸ªå¯¹è±¡åšç»˜åˆ¶è¿™æ ·çš„çŠ¶æ€ã€‚
è°ƒç”¨å®ƒçš„ç»˜ç”»è¡Œä¸ºå¿…ç„¶ä¼šæœ‰å‰¯ä½œç”¨ï¼›
å®ƒæ”¹å˜äº†å®ƒç»˜åˆ¶æ‰€åœ¨è®¾å¤‡çš„å¤–è§‚ï¼ˆåŠå…¶æ‰€å…³è”çš„çŠ¶æ€ï¼‰ã€‚é‰´äºè¿™äº›ï¼Œ`paint()`ä½œä¸º`const`å‡½æ•°å¹¶ä¸åˆç†ã€‚
è¿›ä¸€æ­¥è¯´ï¼Œä»»ä½•`paint()`æˆ–`QIcon`çš„`paint()`çš„è§†å›¾å‡½æ•°æ˜¯`const`å‡½æ•°ä¹Ÿä¸åˆç†ã€‚
æ²¡æœ‰äººä¼šä»å†…éƒ¨çš„`const`å‡½æ•°å»è°ƒç”¨`QIcon::paint()`ï¼Œé™¤éä»–æƒ³æ˜¾å¼åœ°ç»•å¼€`const`è¿™ä¸ªç‰¹æ€§ã€‚
å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œä½¿ç”¨`const_cast`ä¼šæ›´å¥½ã€‚

```cpp
// QAbstractItemDelegate::paint is const
void QAbstractItemDelegate::paint(QPainter **painter, const QStyleOptionViewItem &option, const QModelIndex &index) const

// QGraphicsItem::paint is not const
void QGraphicsItem::paint(QPainter *painter, const QStyleOptionGraphicsItem option, QWidget *widget)
```

`const`å…³é”®å­—å¹¶ä¸èƒ½æŒ‰ä½ æœŸæœ›çš„æ ·å­èµ·ä½œç”¨ã€‚åº”è¯¥è€ƒè™‘å°†å…¶ç§»é™¤è€Œä¸æ˜¯å»é‡è½½`const`/é`const`å‡½æ•°ã€‚

# 5. `API`çš„è¯­ä¹‰å’Œæ–‡æ¡£

å½“ä¼ å€¼ä¸º`-1`çš„å‚æ•°ç»™å‡½æ•°ï¼Œå‡½æ•°ä¼šæ˜¯ä»€ä¹ˆè¡Œä¸ºï¼Ÿæœ‰å¾ˆå¤šç±»ä¼¼çš„é—®é¢˜â€¦â€¦

æ˜¯è­¦å‘Šã€è‡´å‘½é”™è¯¯è¿˜æ˜¯å…¶å®ƒï¼Ÿ

`API`éœ€è¦çš„æ˜¯è´¨é‡ä¿è¯ã€‚`API`ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¸€å®šæ˜¯ä¸å¯¹çš„ï¼›å¿…é¡»å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚
ä»¥é˜…è¯»ä½¿ç”¨`API`çš„ä»£ç çš„æ–¹å¼ç¼–å†™ç”¨ä¾‹ï¼Œä¸”éªŒè¯è¿™æ ·ä»£ç æ˜¯å¯è¯»çš„ã€‚

è¿˜æœ‰å…¶ä»–çš„éªŒè¯æ–¹æ³•ï¼Œæ¯”å¦‚

- è®©åˆ«äººä½¿ç”¨`API`ï¼ˆçœ‹äº†æ–‡æ¡£æˆ–æ˜¯å…ˆä¸çœ‹æ–‡æ¡£éƒ½å¯ä»¥ï¼‰
- ç»™ç±»å†™æ–‡æ¡£ï¼ˆåŒ…å«ç±»çš„æ¦‚è¿°å’Œæ¯ä¸ªå‡½æ•°ï¼‰

# 6. å‘½åçš„è‰ºæœ¯

å‘½åå¾ˆå¯èƒ½æ˜¯`API`è®¾è®¡ä¸­æœ€é‡è¦çš„ä¸€ä¸ªé—®é¢˜ã€‚ç±»åº”è¯¥å«ä»€ä¹ˆåå­—ï¼Ÿæˆå‘˜å‡½æ•°åº”è¯¥å«ä»€ä¹ˆåå­—ï¼Ÿ

## 6.1 é€šç”¨çš„å‘½åè§„åˆ™

æœ‰å‡ ä¸ªè§„åˆ™å¯¹äºæ‰€æœ‰ç±»å‹çš„å‘½åéƒ½ç­‰åŒé€‚ç”¨ã€‚ç¬¬ä¸€ä¸ªï¼Œä¹‹å‰å·²ç»æåˆ°è¿‡ï¼Œä¸è¦ä½¿ç”¨ç¼©å†™ã€‚å³ä½¿æ˜¯æ˜æ˜¾çš„ç¼©å†™ï¼Œæ¯”å¦‚æŠŠ`previous`ç¼©å†™æˆ`prev`ï¼Œä»é•¿è¿œæ¥çœ‹æ˜¯å›æŠ¥æ˜¯è´Ÿçš„ï¼Œå› ä¸ºç”¨æˆ·å¿…é¡»è¦è®°ä½ç¼©å†™è¯çš„å«ä¹‰ã€‚

å¦‚æœ`API`æœ¬èº«æ²¡æœ‰ä¸€è‡´æ€§ï¼Œä¹‹åäº‹æƒ…è‡ªç„¶å°±ä¼šè¶Šæ¥è¶Šç³Ÿï¼›ä¾‹å¦‚ï¼Œ`Qt 3` ä¸­åŒæ—¶å­˜åœ¨`activatePreviousWindow()`ä¸`fetchPrev()`ã€‚æªå®ˆã€ä¸ç¼©å†™ã€è§„åˆ™æ›´å®¹æ˜“åœ°åˆ›å»ºä¸€è‡´æ€§çš„`API`ã€‚

å¦ä¸€ä¸ªæ—¶é‡è¦ä½†æ›´å¾®å¦™çš„å‡†åˆ™æ˜¯åœ¨è®¾è®¡ç±»æ—¶åº”è¯¥ä¿æŒå­ç±»åç§°ç©ºé—´çš„å¹²å‡€ã€‚åœ¨`Qt 3`ä¸­ï¼Œæ­¤é¡¹å‡†åˆ™å¹¶æ²¡æœ‰ä¸€ç›´éµå¾ªã€‚ä»¥`QToolButton`ä¸ºä¾‹å¯¹æ­¤è¿›è¡Œè¯´æ˜ã€‚å¦‚æœè°ƒç”¨`QToolButton`çš„ `name()`ã€`caption()`ã€`text()`æˆ–è€…`textLabel()`ï¼Œä½ è§‰å¾—ä¼šè¿”å›ä»€ä¹ˆï¼Ÿç”¨`Qt`è®¾è®¡å™¨åœ¨`QToolButton`ä¸Šè‡ªå·±å…ˆè¯•è¯•å§ï¼š

- `name`å±æ€§æ˜¯ç»§æ‰¿è‡ª`QObject`ï¼Œè¿”å›å†…éƒ¨çš„å¯¹è±¡åç§°ï¼Œç”¨äºè°ƒè¯•å’Œæµ‹è¯•ã€‚
- `caption`å±æ€§ç»§æ‰¿è‡ª`QWidget`ï¼Œè¿”å›çª—å£æ ‡é¢˜ï¼Œå¯¹`QToolButton`æ¥è¯´æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºå®ƒåœ¨åˆ›å»ºçš„æ—¶å€™parentå°±å­˜åœ¨äº†ã€‚
- `text`å‡½æ•°ç»§æ‰¿è‡ª`QButton`ï¼Œä¸€èˆ¬ç”¨äºæŒ‰é’®ã€‚å½“`useTextLabel`ä¸ä¸º`true`ï¼Œæ‰ç”¨è¿™ä¸ªå±æ€§ã€‚
- `textLabel`å±æ€§åœ¨`QToolButton`å†…å£°æ˜ï¼Œå½“`useTextLabel`ä¸º`true`æ—¶æ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šã€‚

ä¸ºäº†å¯è¯»æ€§ï¼Œåœ¨`Qt 4`ä¸­`QToolButton`çš„`name`å±æ€§æ”¹æˆäº†`objectName`ï¼Œ`caption`æ”¹æˆäº†`windowTitle`ï¼Œåˆ é™¤äº†`textLabel`å±æ€§å› ä¸ºå’Œ`text`å±æ€§ç›¸åŒã€‚

å½“ä½ æ‰¾ä¸åˆ°å¥½çš„å‘½åæ—¶ï¼Œå†™æ–‡æ¡£ä¹Ÿæ˜¯ä¸ªå¾ˆå¥½æ–¹æ³•ï¼šè¦åšçš„å°±æ˜¯å°è¯•ä¸ºå„ä¸ªæ¡ç›®ï¼ˆ`item`ï¼‰ï¼ˆå¦‚ç±»ã€æ–¹æ³•ã€æšä¸¾å€¼ç­‰ç­‰ï¼‰å†™æ–‡æ¡£ï¼Œå¹¶ç”¨å†™ä¸‹çš„ç¬¬ä¸€å¥è¯ä½œä¸ºå¯å‘ã€‚å¦‚æœæ‰¾ä¸åˆ°ä¸€ä¸ªç¡®åˆ‡çš„å‘½åï¼Œå¾€å¾€è¯´æ˜è¿™ä¸ªæ¡ç›®æ˜¯ä¸è¯¥æœ‰çš„ã€‚å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥äº†ï¼Œå¹¶ä¸”ä½ åšä¿¡è¿™ä¸ªæ¦‚å¿µæ˜¯åˆç†çš„ï¼Œé‚£ä¹ˆå°±å‘æ˜ä¸€ä¸ªæ–°åå­—ã€‚åƒ`widget`ã€`event`ã€`focus`å’Œ`buddy`è¿™äº›å‘½åå°±æ˜¯åœ¨è¿™ä¸€æ­¥è¯ç”Ÿçš„ã€‚

> ã€è¯‘æ³¨ã€‘ï¼šå†™æ–‡æ¡£æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚å†™æ–‡æ¡£çš„è¿‡ç¨‹å…¶å®å°±æ˜¯åœ¨å¸®ä½ æ¢³ç†ä½ çš„ç¼–ç¨‹æ€è·¯ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæ–‡æ¡£å†™ç€å†™ç€ä½ å°±ä¼šå‘ç°è¦å»æ”¹ä»£ç å»äº†ã€‚é™¤äº†ä¸Šè¿°çš„å¥½å¤„å¤šï¼Œå†™æ–‡æ¡£è¿˜æœ‰æ›´å¤šçš„å¥½å¤„ã€‚æ¯”å¦‚ï¼Œåœ¨å†™æ–‡æ¡£çš„è¿‡ç¨‹ä¸­ï¼Œä½ å‘ç°æ–‡å­—æè¿°è¿‡äºå¤æ‚äº†ï¼Œè¿™è¡¨æ˜ç€ä½ çš„ä»£ç æˆ–é€»è¾‘æ˜¯å¤æ‚çš„ï¼Œè¿™å°±å€’é€¼ä½ å»é‡æ„ä½ çš„ä»£ç ã€‚æ‰€ä»¥ â€”â€” **å†™æ–‡æ¡£å…¶å®å°±æ˜¯å†™ä»£ç **ã€‚

## 6.2 ç±»çš„å‘½å

è¯†åˆ«å‡ºç±»æ‰€åœ¨çš„åˆ†ç»„ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªç±»éƒ½å»æ‰¾ä¸ªå®Œç¾çš„å‘½åã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰`Qt 4`çš„èƒ½æ„ŸçŸ¥æ¨¡å‹ï¼ˆ`model-aware`ï¼‰çš„`item view`ï¼Œç±»åç¼€éƒ½æ˜¯`View`ï¼ˆ`QListView`ã€`QTableView`ã€`QTreeView`ï¼‰ï¼Œè€Œç›¸åº”çš„åŸºäº`item`ï¼ˆ`item-based`ï¼‰çš„ç±»åç¼€æ˜¯`Widget`ï¼ˆ`QListWidget`ã€`QTableWidget`ã€`QTreeWidget`ï¼‰ã€‚

## 6.3 æšä¸¾ç±»å‹åŠå…¶å€¼çš„å‘½å

å£°æ˜æšä¸¾ç±»å‹æ—¶ï¼Œéœ€è¦è®°ä½åœ¨`C++`ä¸­æšä¸¾å€¼åœ¨ä½¿ç”¨æ—¶ä¸ä¼šå¸¦ä¸Šç±»å‹ï¼ˆä¸`Java`ã€`C#`ä¸åŒï¼‰ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†æšä¸¾å€¼å‘½åå¾—è¿‡äºé€šç”¨çš„å±å®³ï¼š

```cpp
namespace Qt
{
    enum Corner { TopLeft, BottomRight, ... };
    enum CaseSensitivity { Insensitive, Sensitive };
    ...
};

tabWidget->setCornerWidget(widget, Qt::TopLeft);
str.indexOf("$(QTDIR)", Qt::Insensitive);
```

åœ¨æœ€åä¸€è¡Œï¼Œ`Insensitive`æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå‘½åæšä¸¾ç±»å‹çš„ä¸€ä¸ªå‡†åˆ™æ˜¯åœ¨æšä¸¾å€¼ä¸­è‡³å°‘é‡å¤æ­¤æšä¸¾ç±»å‹åä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼š

```cpp
namespace Qt
{
    enum Corner { TopLeftCorner, BottomRightCorner, ... };
    enum CaseSensitivity { CaseInsensitive, CaseSensitive };
    ...
};

tabWidget->setCornerWidget(widget, Qt::TopLeftCorner);
str.indexOf("$(QTDIR)", Qt::CaseInsensitive);
```

å½“å¯¹æšä¸¾å€¼è¿›è¡Œæˆ–è¿ç®—å¹¶ä½œä¸ºæŸç§æ ‡å¿—ï¼ˆ`flag`ï¼‰æ—¶ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯æŠŠæˆ–è¿ç®—çš„ç»“æœä¿å­˜åœ¨`int`å‹çš„å€¼ä¸­ï¼Œä½†è¿™ä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚`Qt 4`æä¾›äº†ä¸€ä¸ªæ¨¡æ¿ç±»`QFlags<T>`ï¼Œå…¶ä¸­çš„`T`æ˜¯æšä¸¾ç±»å‹ã€‚ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œ`Qt`ç”¨`typedef`é‡æ–°å®šä¹‰äº†`QFlag`ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥ç”¨`Qt::Alignment`ä»£æ›¿`QFlags<Qt::AlignmentFlag>`ã€‚

ä¹ æƒ¯ä¸Šï¼Œæšä¸¾ç±»å‹å‘½åç”¨å•æ•°å½¢å¼ï¼ˆå› ä¸ºå®ƒä¸€æ¬¡åªèƒ½ã€æŒæœ‰ã€ä¸€ä¸ª`flag`ï¼‰ï¼Œè€ŒæŒæœ‰å¤šä¸ªã€`flag`ã€çš„ç±»å‹ç”¨å¤æ•°å½¢å¼ï¼Œä¾‹å¦‚ï¼š

```cpp
enum RectangleEdge { LeftEdge, RightEdge, ... };
typedef QFlags<RectangleEdge> RectangleEdges;
```

åœ¨æŸäº›æƒ…å½¢ä¸‹ï¼ŒæŒæœ‰å¤šä¸ªã€`flag`ã€çš„ç±»å‹å‘½åç”¨å•æ•°å½¢å¼ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼ŒæŒæœ‰çš„æšä¸¾ç±»å‹åç§°è¦æ±‚æ˜¯ä»¥`Flag`ä¸ºåç¼€ï¼š

```cpp
enum AlignmentFlag { AlignLeft, AlignTop, ... };
typedef QFlags<AlignmentFlag> Alignment;
```

## 6.4 å‡½æ•°å’Œå‚æ•°çš„å‘½å

å‡½æ•°å‘½åçš„ç¬¬ä¸€å‡†åˆ™æ˜¯å¯ä»¥ä»å‡½æ•°åçœ‹å‡ºæ¥æ­¤å‡½æ•°æ˜¯å¦æœ‰å‰¯ä½œç”¨ã€‚åœ¨`Qt 3`ä¸­ï¼Œ`const`å‡½æ•°`QString::simplifyWhiteSpace()`è¿åäº†æ­¤å‡†åˆ™ï¼Œå› ä¸ºå®ƒè¿”å›äº†ä¸€ä¸ª`QString`è€Œä¸æ˜¯æŒ‰åç§°æš—ç¤ºçš„é‚£æ ·ï¼Œæ”¹å˜è°ƒç”¨å®ƒçš„`QString`å¯¹è±¡ã€‚åœ¨`Qt 4`ä¸­ï¼Œæ­¤å‡½æ•°é‡å‘½åä¸º`QString::simplified()`ã€‚

è™½ç„¶å‚æ•°åä¸ä¼šå‡ºç°åœ¨ä½¿ç”¨`API`çš„ä»£ç ä¸­ï¼Œä½†æ˜¯å®ƒä»¬ç»™ç¨‹åºå‘˜æä¾›äº†é‡è¦ä¿¡æ¯ã€‚å› ä¸ºç°ä»£çš„`IDE`éƒ½ä¼šåœ¨å†™ä»£ç æ—¶æ˜¾ç¤ºå‚æ•°åç§°ï¼Œæ‰€ä»¥å€¼å¾—åœ¨å¤´æ–‡ä»¶ä¸­ç»™å‚æ•°èµ·ä¸€ä¸ªæ°å½“çš„åå­—å¹¶åœ¨æ–‡æ¡£ä¸­ä½¿ç”¨ç›¸åŒçš„åå­—ã€‚

## 6.5 å¸ƒå°”ç±»å‹çš„`getter`ä¸`setter`æ–¹æ³•çš„å‘½å

ä¸º`bool`å±æ€§çš„`getter`å’Œ`setter`æ–¹æ³•å‘½åæ€»æ˜¯å¾ˆç—›è‹¦ã€‚`getter`åº”è¯¥å«åš`checked()`è¿˜æ˜¯`isChecked()`ï¼Ÿ`scrollBarsEnabled()`è¿˜æ˜¯`areScrollBarEnabled()`ï¼Ÿ

`Qt 4`ä¸­ï¼Œæˆ‘ä»¬å¥—ç”¨ä»¥ä¸‹å‡†åˆ™ä¸º`getter`å‘½åï¼š

- å½¢å®¹è¯ä»¥`is`ä¸ºå‰ç¼€ï¼Œä¾‹å­ï¼š
    - `isChecked()`
    - `isDown()`
    - `isEmpty()`
    - `isMovingEnabled()`
- ç„¶è€Œï¼Œä¿®é¥°åè¯çš„å½¢å®¹è¯æ²¡æœ‰å‰ç¼€ï¼š
    - `scrollBarsEnabled()`ï¼Œè€Œä¸æ˜¯`areScrollBarsEnabled()`
- åŠ¨è¯æ²¡æœ‰å‰ç¼€ï¼Œä¹Ÿä¸ä½¿ç”¨ç¬¬ä¸‰äººç§°(`-s`)ï¼š
    - `acceptDrops()`ï¼Œè€Œä¸æ˜¯`acceptsDrops()`
    - `allColumnsShowFocus()`
- åè¯ä¸€èˆ¬æ²¡æœ‰å‰ç¼€ï¼š
    - `autoCompletion()`ï¼Œè€Œä¸æ˜¯`isAutoCompletion()`
    - `boundaryChecking()`
- æœ‰çš„æ—¶å€™ï¼Œæ²¡æœ‰å‰ç¼€å®¹æ˜“äº§ç”Ÿè¯¯å¯¼ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šåŠ ä¸Š`is`å‰ç¼€ï¼š
    - `isOpenGLAvailable()`ï¼Œè€Œä¸æ˜¯`openGL()`
    - `isDialog()`ï¼Œè€Œä¸æ˜¯`dialog()`  
      ï¼ˆä¸€ä¸ªå«åš`dialog()`çš„å‡½æ•°ï¼Œä¸€èˆ¬ä¼šè¢«è®¤ä¸ºæ˜¯è¿”å›`QDialog`ã€‚ï¼‰

`setter`çš„åå­—ç”±`getter`è¡ç”Ÿï¼Œå»æ‰äº†å‰ç¼€ååœ¨å‰é¢åŠ ä¸Šäº†`set`ï¼›ä¾‹å¦‚ï¼Œ`setDown()`ä¸`setScrollBarsEnabled()`ã€‚

# 7. é¿å…å¸¸è§é™·é˜±

## 7.1 ç®€åŒ–çš„é™·é˜±

ä¸€ä¸ªå¸¸è§çš„è¯¯è§£æ˜¯ï¼šå®ç°éœ€è¦å†™çš„ä»£ç è¶Šå°‘ï¼Œ`API`å°±è®¾è®¡å¾—è¶Šå¥½ã€‚åº”è¯¥è®°ä½ï¼šä»£ç åªä¼šå†™ä¸Šå‡ æ¬¡ï¼Œå´è¦è¢«åå¤é˜…è¯»å¹¶ç†è§£ã€‚ä¾‹å¦‚ï¼š

```cpp
QSlider *slider = new QSlider(12, 18, 3, 13, Qt::Vertical, 0, "volume");
```

è¿™æ®µä»£ç æ¯”ä¸‹é¢çš„è¯»èµ·æ¥è¦éš¾å¾—å¤šï¼ˆç”šè‡³å†™èµ·æ¥ä¹Ÿæ›´éš¾ï¼‰ï¼š

```cpp
QSlider *slider = new QSlider(Qt::Vertical);
slider->setRange(12, 18);
slider->setPageStep(3);
slider->setValue(13);
slider->setObjectName("volume");
```

>ã€è¯‘æ³¨ã€‘ï¼šåœ¨æœ‰`IDE`çš„è‡ªåŠ¨æç¤ºçš„æ”¯æŒä¸‹ï¼Œåè€…å†™èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œè€Œå‰è€…è¿˜éœ€è¦çœ‹ç›¸åº”çš„æ–‡æ¡£ã€‚

## 7.2 å¸ƒå°”å‚æ•°çš„é™·é˜±

å¸ƒå°”ç±»å‹çš„å‚æ•°æ€»æ˜¯å¸¦æ¥æ— æ³•é˜…è¯»çš„ä»£ç ã€‚ç»™ç°æœ‰çš„å‡½æ•°å¢åŠ ä¸€ä¸ª`bool`å‹çš„å‚æ•°å‡ ä¹æ°¸è¿œæ˜¯ä¸€ç§é”™è¯¯çš„è¡Œä¸ºã€‚ä»ä»¥`Qt`ä¸ºä¾‹ï¼Œ`repaint()`æœ‰ä¸€ä¸ª`bool`ç±»å‹çš„å¯é€‰å‚æ•°ç”¨äºæŒ‡å®šèƒŒæ™¯æ˜¯å¦è¢«æ“¦é™¤ã€‚å¯ä»¥å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š

```cpp
widget->repaint(false);
```

åˆå­¦è€…å¾ˆå¯èƒ½æ˜¯è¿™æ ·ç†è§£çš„ï¼Œã€ä¸è¦é‡æ–°ç»˜åˆ¶ï¼ã€ï¼Œèƒ½æœ‰å¤šå°‘`Qt`ç”¨æˆ·çœŸå¿ƒçŸ¥é“ä¸‹é¢3è¡Œæ˜¯ä»€ä¹ˆæ„æ€ï¼š

```cpp
widget->repaint();
widget->repaint(true);
widget->repaint(false);
```

æ›´å¥½çš„`API`è®¾è®¡åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```cpp
widget->repaint();
widget->repaintWithoutErasing();
```

åœ¨`Qt 4`ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç§»é™¤äº†é‡æ–°ç»˜åˆ¶ï¼ˆ`repaint`ï¼‰è€Œä¸æ“¦é™¤`widget`çš„èƒ½åŠ›æ¥è§£å†³äº†æ­¤é—®é¢˜ã€‚`Qt 4`çš„åŒç¼“å†²ä½¿è¿™ç§ç‰¹æ€§è¢«åºŸå¼ƒã€‚

è¿˜æœ‰æ›´å¤šçš„ä¾‹å­ï¼š

```cpp
widget->setSizePolicy(QSizePolicy::Fixed, QSizePolicy::Expanding, true);
textEdit->insert("Where's Waldo?", true, true, false);
QRegExp rx("moc_***.c??", false, true);
```

ä¸€ä¸ªæ˜æ˜¾çš„è§£å†³æ–¹æ¡ˆæ˜¯`bool`ç±»å‹æ”¹æˆæšä¸¾ç±»å‹ã€‚æˆ‘ä»¬åœ¨`Qt 4`çš„`QString`ä¸­å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚å¯¹æ¯”æ•ˆæœå¦‚ä¸‹ï¼š

```cpp
str.replace("%USER%", user, false);               // Qt 3
str.replace("%USER%", user, Qt::CaseInsensitive); // Qt 4
```

> ã€è¯‘æ³¨ã€‘ï¼šå…³äºè¿™ä¸ªæ¡ç›®å¯ä»¥çœ‹çœ‹`CoolShell`è¿™ç¯‡æ–‡ç« ä¸€äº›å±•å¼€çš„è®¨è®ºï¼š [åƒä¸‡ä¸è¦æŠŠ BOOL è®¾è®¡æˆå‡½æ•°å‚æ•°]( https://coolshell.cn/articles/5444.html)ã€‚

# 8. æ¡ˆä¾‹ç ”ç©¶

## 8.1 `QProgressBar`

ä¸ºäº†å±•ç¤ºä¸Šæ–‡å„ç§å‡†åˆ™çš„å®é™…åº”ç”¨ã€‚æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹`Qt 3`ä¸­`QProgressBar`çš„`API`ï¼Œå¹¶ä¸`Qt 4`ä¸­å¯¹åº”çš„`API`ä½œæ¯”è¾ƒã€‚åœ¨`Qt 3`ä¸­ï¼š

```cpp
class QProgressBar : public QWidget
{
    ...
public:
    int totalSteps() const;
    int progress() const;

    const QString &progressString() const;
    bool percentageVisible() const;
    void setPercentageVisible(bool);

    void setCenterIndicator(bool on);
    bool centerIndicator() const;

    void setIndicatorFollowsStyle(bool);
    bool indicatorFollowsStyle() const;

public slots:
    void reset();
    virtual void setTotalSteps(int totalSteps);
    virtual void setProgress(int progress);
    void setProgress(int progress, int totalSteps);

protected:
    virtual bool setIndicator(QString &progressStr,
                              int progress,
                              int totalSteps);
    ...
};
```

è¯¥`API`ç›¸å½“çš„å¤æ‚å’Œä¸ä¸€è‡´ï¼›ä¾‹å¦‚ï¼Œ`reset()`ã€`setTotalSteps()`ã€`setProgress()`æ˜¯ç´§å¯†è”ç³»çš„ï¼Œä½†æ–¹æ³•çš„å‘½åå¹¶æ²¡æ˜ç¡®åœ°è¡¨è¾¾å‡ºæ¥ã€‚

æ”¹å–„æ­¤`API`çš„å…³é”®æ˜¯æŠ“ä½`QProgressBar`ä¸`Qt 4`çš„`QAbstractSpinBox`åŠå…¶å­ç±»`QSpinBox`ã€`QSlider`ã€`QDail`ä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚æ€ä¹ˆåšï¼ŸæŠŠ`progress`ã€`totalSteps`æ›¿æ¢ä¸º`minimum`ã€`maximum`å’Œ`value`ã€‚å¢åŠ ä¸€ä¸ª`valueChanged()`æ¶ˆæ¯ï¼Œå†å¢åŠ ä¸€ä¸ª`setRange()`å‡½æ•°ã€‚

è¿›ä¸€æ­¥å¯ä»¥è§‚å¯Ÿåˆ°`progressString`ã€`percentage`ä¸`indicator`å…¶å®æ˜¯ä¸€å›äº‹ï¼Œå³æ˜¯æ˜¾ç¤ºåœ¨è¿›åº¦æ¡ä¸Šçš„æ–‡æœ¬ã€‚é€šå¸¸è¿™ä¸ªæ–‡æœ¬æ˜¯ä¸ªç™¾åˆ†æ¯”ï¼Œä½†æ˜¯å¯é€šè¿‡`setIndicator()`è®¾ç½®ä¸ºä»»ä½•å†…å®¹ã€‚ä»¥ä¸‹æ˜¯æ–°çš„`API`ï¼š

```cpp
virtual QString text() const;
void setTextVisible(bool visible);
bool isTextVisible() const;
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºæ–‡æœ¬æ˜¯ç™¾åˆ†æ¯”æŒ‡ç¤ºå™¨ï¼ˆ`percentage indicator`ï¼‰ï¼Œé€šè¿‡é‡å†™`text()`æ–¹æ³•æ¥å®šåˆ¶è¡Œä¸ºã€‚

`Qt 3`çš„`setCenterIndicator()`ä¸`setIndicatorFollowsStyle()`æ˜¯ä¸¤ä¸ªå½±å“å¯¹é½æ–¹å¼çš„å‡½æ•°ã€‚ä»–ä»¬å¯è¢«ä¸€ä¸ª`setAlignment()`å‡½æ•°ä»£æ›¿ï¼š

```cpp
void setAlignment(Qt::Alignment alignment);
```

å¦‚æœå¼€å‘è€…æœªè°ƒç”¨`setAlignment()`ï¼Œé‚£ä¹ˆå¯¹é½æ–¹å¼ç”±é£æ ¼å†³å®šã€‚å¯¹äºåŸºäº`Motif`çš„é£æ ¼ï¼Œæ–‡å­—å†…å®¹åœ¨ä¸­é—´æ˜¾ç¤ºï¼›å¯¹äºå…¶ä»–é£æ ¼ï¼Œåœ¨å³ä¾§æ˜¾ç¤ºã€‚

ä¸‹é¢æ˜¯æ”¹å–„åçš„`QProgressBar API`:

```cpp
class QProgressBar : public QWidget
{
    ...
public:
    void setMinimum(int minimum);
    int minimum() const;
    void setMaximum(int maximum);
    int maximum() const;
    void setRange(int minimum, int maximum);
    int value() const;

    virtual QString text() const;
    void setTextVisible(bool visible);
    bool isTextVisible() const;
    Qt::Alignment alignment() const;
    void setAlignment(Qt::Alignment alignment);

public slots:
    void reset();
    void setValue(int value);

signals:
    void valueChanged(int value);
    ...
};
```

## 8.2 `QAbstractPrintDialog` & `QAbstractPageSizeDialog`

`Qt 4.0`æœ‰2ä¸ªå¹½çµç±»`QAbstractPrintDialog`å’Œ`QAbstractPageSizeDialog`ï¼Œä½œä¸º
`QPrintDialog`å’Œ`QPageSizeDialog`ç±»çš„çˆ¶ç±»ã€‚è¿™2ä¸ªç±»å®Œå…¨æ²¡æœ‰ç”¨ï¼Œå› ä¸º`Qt`çš„`API`æ²¡æœ‰æ˜¯`QAbstractPrint-`æˆ–æ˜¯`-PageSizeDialog`æŒ‡é’ˆä½œä¸ºå‚æ•°å¹¶æ‰§è¡Œæ“ä½œã€‚é€šè¿‡ç¯¡æ”¹`qdoc`ï¼ˆ`Qtæ–‡æ¡£`ï¼‰ï¼Œæˆ‘ä»¬è™½ç„¶æŠŠè¿™2ä¸ªç±»éšè—èµ·æ¥äº†ï¼Œå´æˆäº†æ— ç”¨æŠ½è±¡ç±»çš„å…¸å‹æ¡ˆä¾‹ã€‚

è¿™ä¸æ˜¯è¯´ï¼Œ**_å¥½_** çš„æŠ½è±¡æ˜¯é”™çš„ï¼Œ`QPrintDialog`åº”è¯¥æ˜¯éœ€è¦æœ‰ä¸ªå·¥å‚æˆ–æ˜¯å…¶å®ƒæ”¹å˜çš„æœºåˆ¶ â€”â€” è¯æ®å°±æ˜¯å®ƒå£°æ˜ä¸­çš„`#ifdef QTOPIA_PRINTDIALOG`ã€‚

## 8.3 `QAbstractItemModel`

å…³äºæ¨¡å‹/è§†å›¾ï¼ˆ`model`/`view`ï¼‰é—®é¢˜çš„ç»†èŠ‚åœ¨ç›¸åº”çš„æ–‡æ¡£ä¸­å·²ç»è¯´æ˜å¾—å¾ˆå¥½äº†ï¼Œä½†ä½œä¸ºä¸€ä¸ªé‡è¦çš„æ€»ç»“è¿™é‡Œè¿˜éœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼šæŠ½è±¡ç±»ä¸åº”è¯¥ä»…æ˜¯æ‰€æœ‰å¯èƒ½å­ç±»çš„å¹¶é›†ï¼ˆ`union`ï¼‰ã€‚è¿™æ ·ã€åˆå¹¶æ‰€æœ‰ã€çš„çˆ¶ç±»å‡ ä¹ä¸å¯èƒ½æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆã€‚`QAbstractItemModel`å°±çŠ¯äº†è¿™ä¸ªé”™è¯¯ â€”â€” å®ƒå®é™…ä¸Šå°±æ˜¯ä¸ª`QTreeOfTablesModel`ï¼Œç»“æœå¯¼è‡´äº†é”™ç»¼å¤æ‚ï¼ˆ`complicated`ï¼‰çš„`API`ï¼Œè€Œè¿™æ ·çš„`API`è¦è®© **_æ‰€æœ‰æœ¬æ¥è®¾è®¡è¿˜ä¸é”™çš„å­ç±»_** å»ç»§æ‰¿ã€‚

ä»…ä»…å¢åŠ æŠ½è±¡æ˜¯ä¸ä¼šè‡ªåŠ¨å°±æŠŠ`API`å˜å¾—æ›´å¥½çš„ã€‚

## 8.4 `QLayoutIterator` & `QGLayoutIterator`

åœ¨`Qt 3`ï¼Œåˆ›å»ºè‡ªå®šä¹‰çš„å¸ƒå±€ç±»éœ€è¦åŒæ—¶ç»§æ‰¿`QLayout`å’Œ`QGLayoutIterator`ï¼ˆå‘½åä¸­çš„`G`æ˜¯æŒ‡`Generic`ï¼ˆé€šç”¨ï¼‰ï¼‰ã€‚`QGLayoutIterator`å­ç±»çš„å®ä¾‹æŒ‡é’ˆä¼šåŒ…è£…æˆ`QLayoutIterator`ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥åƒå’Œå…¶å®ƒçš„è¿­ä»£å™¨ï¼ˆ`iterator`ï¼‰ç±»ä¸€æ ·çš„æ–¹å¼æ¥ä½¿ç”¨ã€‚é€šè¿‡`QLayoutIterator`å¯ä»¥å†™å‡ºä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š

```cpp
QLayoutIterator it = layout()->iterator();
QLayoutItem **child;
while ((child = it.current()) != 0) {
    if (child->widget() == myWidget) {
        it.takeCurrent();
        return;
    }
    ++it;
}
```

åœ¨`Qt 4`ï¼Œæˆ‘ä»¬å¹²æ‰äº†`QGLayoutIterator`ç±»ï¼ˆä»¥åŠç”¨äºç›’å­å¸ƒå±€å’Œæ ¼å­å¸ƒå±€çš„å†…éƒ¨å­ç±»ï¼‰ï¼Œè½¬è€Œæ˜¯è®©`QLayout`çš„å­ç±»é‡å†™`itemAt()`ã€`takeAt()`å’Œ`count()`ã€‚

## 8.5 `QImageSink`

`Qt 3`æœ‰ä¸€æ•´å¥—ç±»ç”¨æ¥æŠŠå®Œæˆå¢é‡åŠ è½½çš„å›¾ç‰‡ä¼ é€’ç»™ä¸€ä¸ªåŠ¨ç”» â€”â€” `QImageSource`/`Sink`/`QASyncIO`/`QASyncImageIO`ã€‚ç”±äºè¿™äº›ç±»ä¹‹å‰åªæ˜¯ç”¨äºå¯ç”¨åŠ¨ç”»çš„`QLabel`ï¼Œå®Œå…¨è¿‡åº¦è®¾è®¡äº†ï¼ˆ`overkill`ï¼‰ã€‚

ä»ä¸­å¾—åˆ°çš„æ•™è®­å°±æ˜¯ï¼šå¯¹äºé‚£äº›æœªæ¥å¯èƒ½çš„è¿˜ä¸æ˜æœ—çš„éœ€æ±‚ï¼Œä¸è¦è¿‡æ—©åœ°å¢åŠ æŠ½è±¡è®¾è®¡ã€‚å½“éœ€æ±‚çœŸçš„å‡ºç°æ—¶ï¼Œæ¯”èµ·ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿï¼Œåœ¨ç®€å•çš„ç³»ç»Ÿæ–°å¢éœ€æ±‚è¦å®¹æ˜“å¾—å¤šã€‚
